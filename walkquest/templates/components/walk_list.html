{% load i18n %}
{% load slippers %}

{{ walks|json_script:"walks-data" }}

<div class="flex flex-col space-y-4 p-4"
     x-data="{
         walks: [],
         isLoading: false,
         isLoadingMore: false,
         hasMore: false,
         error: null,
         searchQuery: '',
         page: 1,
         
         async init() {
             console.log('Initializing walkList component...');
             const walksData = document.getElementById('walks-data');
             if (walksData) {
                 try {
                     const initialData = JSON.parse(walksData.textContent);
                     this.walks = initialData.walks || [];
                     this.hasMore = initialData.hasMore || false;
                     
                     // Initialize selected walk if we have walks
                     if (this.walks.length > 0) {
                         Alpine.store('walks').setSelectedWalk(this.walks[0]);
                     }
                 } catch (err) {
                     console.error('Failed to parse initial walks data:', err);
                 }
             }
             await this.fetchWalks();
         },

         async fetchWalks() {
             this.isLoading = true;
             this.error = null;
             try {
                 const response = await window.ApiService.filterWalks({
                     search: this.searchQuery,
                     page: 1,
                     page_size: 10
                 });
                 this.walks = response.walks || [];
                 this.hasMore = (response.walks || []).length >= 10;
                 this.page = 1;
             } catch (err) {
                 console.error('Failed to fetch walks:', err);
                 this.error = 'Failed to load walks. Please try again.';
             } finally {
                 this.isLoading = false;
             }
         },

         async loadMore() {
             if (this.isLoadingMore || !this.hasMore) return;
             this.isLoadingMore = true;
             this.page++;
             try {
                 const response = await window.ApiService.filterWalks({
                     search: this.searchQuery,
                     page: this.page,
                     page_size: 10
                 });
                 const newWalks = response.walks || [];
                 this.walks = [...this.walks, ...newWalks];
                 this.hasMore = newWalks.length >= 10;
             } catch (err) {
                 console.error('Failed to load more walks:', err);
                 this.error = 'Failed to load more walks. Please try again.';
                 this.page--;
             } finally {
                 this.isLoadingMore = false;
             }
         },

         checkScroll() {
             const scrollPosition = window.innerHeight + window.scrollY;
             const documentHeight = document.documentElement.scrollHeight;
             const threshold = 200;
             if (documentHeight - scrollPosition < threshold) {
                 this.loadMore();
             }
         }
     }"
     x-init="init()"
     @scroll.window.debounce.100ms="checkScroll">
    
    <!-- Debug info -->
    <template x-if="true">
        <div x-show="false" class="hidden">
            <pre x-effect="console.log('Component State:', $data)"></pre>
        </div>
    </template>

    <!-- Search Bar -->
    <div class="sticky top-0 z-50 bg-white/80 backdrop-blur-sm border-b border-gray-200 -mx-4 px-4 py-3 shadow-sm"
         :class="{ 'shadow-md': window.scrollY > 0 }">
        <label for="search" class="block text-sm font-medium text-gray-700 mb-1">{% translate 'Find walks' %}</label>
        <div class="relative">
            <input type="text" 
                   id="search"
                   x-model="searchQuery"
                   @input.debounce.300ms="fetchWalks"
                   placeholder="{% translate 'Search walks...' %}"
                   class="w-full px-4 py-2 border rounded-lg bg-white/90 text-gray-900 placeholder-gray-500
                          focus:ring-2 focus:ring-primary-500 focus:border-primary-500 focus:outline-none
                          transition-all duration-200 shadow-sm hover:shadow-md">
            <div class="text-xs text-gray-500 mt-1">{% translate 'Search by name, location, or description' %}</div>
        </div>
    </div>

    <!-- Error and Loading States -->
    <template x-if="error">
        <div class="bg-red-50 border-l-4 border-red-400 p-4">
            <p class="text-sm text-red-700" x-text="error"></p>
        </div>
    </template>

    <!-- Loading State -->
    <div x-show="isLoading" class="space-y-4">
        {% include "components/loading_skeleton.html" %}
    </div>

    <!-- Walk List Content -->
    <div x-show="!isLoading" x-cloak class="space-y-4">
        <template x-if="walks.length === 0">
            <div class="text-center py-8 text-gray-500">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">{% translate 'No walks found' %}</h3>
                <p class="mt-1 text-sm text-gray-500">{% translate 'Try adjusting your search or filters.' %}</p>
            </div>
        </template>

        <div class="space-y-4">
            <template x-for="walk in walks" :key="walk.id">
                <div x-data="{ walk: walk }"
                     x-intersect:enter.once="$el.classList.add('revealed')"
                     class="opacity-0 transform translate-y-4 transition-all duration-300 ease-out revealed:opacity-100 revealed:translate-y-0">
                    {% #walk_card %}{% /walk_card %}
                </div>
            </template>
        </div>

        <!-- Load More Indicator -->
        <div x-show="isLoadingMore" class="py-4">
            {% #loading %}Loading more walks...{% /loading %}
        </div>

        <!-- End of List Indicator -->
        <div x-show="!hasMore && walks.length > 0" class="text-center py-4 text-gray-500">
            {% translate 'No more walks to load' %}
        </div>
    </div>
</div>

<style>
    .revealed {
        opacity: 1;
        transform: translateY(0);
    }
</style>
