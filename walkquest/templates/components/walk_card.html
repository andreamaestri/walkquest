{% load slippers %}
{% load i18n %}

<div class="walk-item p-3 md:p-5 backdrop-blur-md rounded-xl shadow-sm hover:shadow-lg
            transition-all duration-300 ease-out cursor-pointer"
            :data-walk-id="walk.id"
            border border-white/20 hover:border-primary-200/50
            bg-white/5 hover:bg-white/10 group relative
            w-full max-w-4xl mx-auto transform-gpu backface-visibility-hidden"
     :class="{
  'expanded': expanded,
  'border-blue-500/50 bg-white/25': $store.walks.selectedWalk?.id === walk.id,
  'walk-item-pending': $store.walks.pendingFavorites.has(walk.id),
  'opacity-0 translate-y-4': !inView,
  'opacity-100 translate-y-0': inView
}"
style="transition: opacity 0.5s ease-out, transform 0.5s ease-out"
     :key="walk.id"
     x-data="{
               expanded: false,
               walk: walk,
               inView: false,
               toggleExpand(event) {
                   if (event.target.closest('.favorite-btn, .action-btn')) return;
                   
                   const wasExpanded = this.expanded;
                   this.expanded = !wasExpanded;
                   
                   // When expanding, dispatch event for map interaction
                   if (!wasExpanded) {
                       window.dispatchEvent(new CustomEvent('walk:selected', {
                           detail: this.walk
                       }));
                   }
               },
               handleSelection() {
                   $store.walks.setSelectedWalk(this.walk);
                   const targetEl = $el.getBoundingClientRect();
                   const viewportHeight = window.innerHeight;
                   if (targetEl.top < 0 || targetEl.bottom > viewportHeight) {
                       $el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                   }
               }
           }"
           x-intersect:enter.margin.100px="inView = true"
           x-intersect:leave.margin.100px="inView = false"
           x-intersect:enter.margin.100px="$nextTick(() => { if ($store.walks.selectedWalk?.id === walk.id && !expanded) toggleExpand($event) })"
           @click="toggleExpand($event)"
     @keydown.space.prevent="toggleExpand($event)"
     @keydown.enter.prevent="toggleExpand($event)"
     role="button"
     tabindex="0">

    <!-- Enhanced Header Section -->
    <div class="flex justify-between items-start gap-4 pb-4 border-b border-white/10">
        <div class="flex-1 space-y-3">
            <h3 class="text-xl md:text-2xl font-bold text-gray-900 group-hover:text-primary-900
                       transition-colors duration-200 line-clamp-2"
                :class="{ 'md:text-3xl': expanded }"
                x-text="walk.walk_name"></h3>
            
            <!-- Enhanced Info Row -->
            <div class="flex flex-wrap items-center gap-3 text-sm md:text-base text-gray-600">
                <span class="flex items-center gap-2 bg-white/10 px-3 py-1.5 rounded-lg font-medium">
                    <iconify-icon icon="mdi:map-marker-distance" class="w-5 h-5"></iconify-icon>
                    <span x-text="`${walk.distance?.toFixed(1) || 0} miles`"></span>
                </span>
                <span x-show="walk.steepness_level" class="flex items-center gap-2 bg-gray-900/5 px-3 py-1.5 rounded-lg font-medium">
                    <iconify-icon icon="mdi:mountain" class="w-5 h-5 text-primary-600"></iconify-icon>
                    <span x-text="walk.steepness_level"></span>
                </span>
            </div>
        </div>

        <!-- Enhanced Favorite Button -->
        <button class="favorite-btn p-3 rounded-lg bg-white/5 hover:bg-white/15
                       transition-all duration-200 transform hover:scale-105
                       focus:outline-none focus:ring-2 focus:ring-primary-500/50
                       transform-gpu backface-visibility-hidden group/fav"
                @click.stop="$dispatch('toggle-favorite', { walkId: walk.id })"
                :aria-label="walk.is_favorite ? 'Remove from favorites' : 'Add to favorites'">
            <iconify-icon icon="mdi:heart" class="w-6 h-6"
                         :class="walk.is_favorite ? 'text-red-500' : 'text-gray-400 group-hover/fav:text-red-400'">
            </iconify-icon>
        </button>
    </div>
   
    <!-- Categories -->
    <div x-show="walk.related_categories?.length > 0" class="mt-0 flex flex-wrap gap-2">
        <template x-for="category in walk.related_categories?.slice(0, 3)" :key="category.slug">
            <span class="category-tag inline-flex items-center px-3 py-1.5
                        rounded-lg text-sm font-medium
                        bg-blue-500 text-white
                        border border-white/10 hover:bg-blue-600
                        transform-gpu backface-visibility-hidden transition-all duration-200
                        hover:scale-105 hover:shadow-sm">
                <span class="whitespace-nowrap" x-text="category.name"></span>
            </span>
        </template>
    </div>

    <!-- Expandable Content -->
    <div class="expandable-content w-full overflow-hidden transform-gpu backface-visibility-hidden"
         :class="{
             'mt-4 mb-2 max-h-[2000px] opacity-100 translate-y-0': expanded,
             'mt-0 max-h-0 opacity-0 -translate-y-4': !expanded
         }"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 -translate-y-4"
         x-transition:enter-end="opacity-100 translate-y-0"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 translate-y-0"
         x-transition:leave-end="opacity-0 -translate-y-4"
         style="transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1)">
        
        <!-- Optimized Bento Grid Layout -->
        <div class="grid grid-cols-1 gap-3 w-full">

            <!-- Additional Categories -->
            <div x-show="walk.related_categories?.length > 3" class="flex flex-wrap gap-2">
                <template x-for="category in walk.related_categories?.slice(3)" :key="category.slug">
                    <span class="category-tag inline-flex items-center px-3 py-1.5
                        rounded-lg text-sm font-medium
                        bg-blue-500 text-white
                        border border-white/10 hover:bg-blue-600
                        transform-gpu backface-visibility-hidden transition-all duration-200
                        hover:scale-105 hover:shadow-sm">
                        <span x-text="category.name"></span>
                    </span>
                </template>
            </div>

            <!-- Description Card -->
            <div x-show="walk.highlights" class="w-full bg-white/25 p-5 rounded-xl">
                <h3 class="text-lg font-medium mb-3 flex items-center gap-2 text-slate-800">
                    <iconify-icon icon="mdi:text-box-outline" class="w-5 h-5 text-primary-600"></iconify-icon>
                    {% translate "Highlights" %}
                </h3>
                <div class="prose max-w-none leading-relaxed" :class="{ 'line-clamp-none': expanded, 'line-clamp-2': !expanded }">
                    <p x-text="walk.highlights" class="whitespace-pre-line text-slate-700"></p>
                </div>
            </div>

            <!-- Enhanced Bento Grid Layout for Walk Details -->
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 auto-rows-max">
                <!-- Points of Interest -->
                <div x-show="walk.points_of_interest" class="col-span-2 sm:col-span-3 bg-white/15 px-3 py-2.5 rounded-xl transform hover:scale-102 transition-transform duration-200">
                    <div class="flex items-center gap-2 text-slate-800 text-sm mb-1.5">
                        <iconify-icon icon="mdi:star" class="w-4 h-4 text-primary-600"></iconify-icon>
                        {% translate "Points of Interest" %}
                    </div>
                    <p class="text-slate-700 text-sm leading-snug" :class="{ 'line-clamp-none': expanded, 'line-clamp-2': !expanded }" x-text="walk.points_of_interest"></p>
                </div>

                <!-- Pubs List -->
                <div x-show="walk.pubs_list?.length > 0" class="col-span-2 sm:col-span-1 bg-white/15 px-3 py-2.5 rounded-xl transform hover:scale-102 transition-transform duration-200">
                    <div class="flex items-center gap-2 text-slate-800 text-sm mb-1.5">
                        <iconify-icon icon="mdi:beer" class="w-4 h-4 text-primary-600"></iconify-icon>
                        {% translate "Pubs" %}
                    </div>
                    <div class="flex flex-wrap gap-1">
                        <template x-for="pub in walk.pubs_list" :key="pub.name">
                            <span class="inline-flex items-center bg-white/15 px-2 py-0.5 rounded text-xs text-slate-700">
                                <span x-text="pub.name"></span>
                            </span>
                        </template>
                    </div>
                </div>

                <!-- Trail Considerations -->
                <div x-show="walk.trail_considerations" class="col-span-4 bg-white/15 px-3 py-2.5 rounded-xl transform hover:scale-102 transition-transform duration-200">
                    <div class="flex items-center gap-2 text-slate-800 text-sm mb-1.5">
                        <iconify-icon icon="mdi:alert" class="w-4 h-4 text-primary-600"></iconify-icon>
                        {% translate "Trail Notes" %}
                    </div>
                    <p class="text-slate-700 text-sm leading-snug" :class="{ 'line-clamp-none': expanded, 'line-clamp-2': !expanded }" x-text="walk.trail_considerations"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Features Icons -->
    <div class="mt-6 flex flex-wrap justify-between items-center gap-4 text-sm text-gray-600 border-t border-white/10 pt-4">
        <div class="flex flex-wrap gap-3">
            <template x-if="walk.has_pub">
                <span class="inline-flex items-center gap-2 bg-white/20 px-3 py-1.5 rounded-lg hover:bg-white/15 transition-colors duration-200">
                    <iconify-icon icon="mdi:beer" class="w-5 h-5 text-primary-600"></iconify-icon>
                    {% translate "Pub Stop" %}
                </span>
            </template>
            <template x-if="walk.has_cafe">
                <span class="inline-flex items-center gap-2 bg-white/20 px-3 py-1.5 rounded-lg hover:bg-white/15 transition-colors duration-200">
                    <iconify-icon icon="mdi:coffee" class="w-5 h-5 text-primary-600"></iconify-icon>
                    {% translate "Café Stop" %}
                </span>
            </template>
            <template x-if="walk.has_bus_access">
                <span class="inline-flex items-center gap-2 bg-white/20 px-3 py-1.5 rounded-lg hover:bg-white/15 transition-colors duration-200">
                    <iconify-icon icon="mdi:bus" class="w-5 h-5 text-primary-600"></iconify-icon>
                    {% translate "Bus Access" %}
                </span>
            </template>
            <template x-if="walk.has_parking">
                <span class="inline-flex items-center gap-2 bg-white/20 px-3 py-1.5 rounded-lg hover:bg-white/15 transition-colors duration-200">
                    <iconify-icon icon="mdi:parking" class="w-5 h-5 text-primary-600"></iconify-icon>
                    {% translate "Parking" %}
                </span>
            </template>
        </div>
        <template x-if="walk.footwear_category">
            <span class="inline-flex items-center gap-2 bg-gray-900/5 px-3 py-1.5 rounded-lg text-primary-700">
                <iconify-icon icon="mdi:shoe-sneaker" class="w-5 h-5"></iconify-icon>
                <span x-text="walk.footwear_category"></span>
            </span>
        </template>
    </div>
</div>