{% load slippers %}
{% load i18n %}

<div class="walk-item p-3 backdrop-blur-md rounded-xl shadow-sm hover:shadow-md 
            transition-all duration-300 ease-out cursor-pointer 
            border border-white/20 hover:border-primary-200/50 
            bg-white/5 hover:bg-white/10 group"
     :class="{
         'expanded p-4': expanded,
         'border-primary-500/50 bg-white/15': $store.walks.selectedWalk?.id === walk.id,
         'walk-item-pending': $store.walks.pendingFavorites.has(walk.id)
     }" 
     :key="walk.id"
     x-data="{ 
         expanded: false,
         walk: walk,
         toggleExpand(event) {
             if (event.target.closest('.favorite-btn')) return;
             this.expanded = !this.expanded;
             if (this.expanded && $store.walks) {
                 $store.walks.setSelectedWalk(this.walk);
             }
         }
     }"
     @click="toggleExpand($event)">
     
    <!-- Header Section -->
    <div class="flex justify-between items-start gap-3">
        <!-- Title Section with proper pointer events -->
        <div class="flex-1 pointer-events-none">
            <h3 class="text-lg font-semibold text-gray-900 group-hover:text-primary-900 
                       transition-colors duration-200"
                :class="{ 'text-xl': expanded, 'line-clamp-1': !expanded }"
                x-text="walk.walk_name"></h3>
            
            <!-- Basic Info Row -->
            <div class="mt-1.5 flex items-center gap-2 text-sm text-gray-600">
                <span x-text="`${walk.distance?.toFixed(1) || 0} miles`"></span>
                <span class="text-gray-400">•</span>
                <span x-text="walk.steepness_level || 'Easy'"></span>
            </div>
        </div>

        <!-- Favorite Button with isolated click handling -->
        <button class="favorite-btn p-2 rounded-full hover:bg-white/10 
                       transition-colors duration-200 pointer-events-auto"
                @click.stop="$dispatch('toggle-favorite', { walkId: walk.id })"
                :aria-label="walk.is_favorite ? 'Remove from favorites' : 'Add to favorites'">
            <iconify-icon icon="mdi:heart" class="w-5 h-5"
                         :class="walk.is_favorite ? 'text-red-500' : 'text-gray-400'">
            </iconify-icon>
        </button>
    </div>

    <!-- Primary Categories -->
    <div class="mt-2 flex flex-wrap gap-2">
        <template x-for="category in walk.categories?.slice(0, 3)" :key="category.slug">
            <span class="category-tag inline-flex items-center px-2.5 py-1 
                        rounded-full text-xs font-medium bg-primary-50/50 
                        text-primary-700 pointer-events-none
                        transition-all duration-300">
                <span x-text="category.name"></span>
            </span>
        </template>
    </div>

    <!-- Expandable Content -->
    <div class="expandable-content overflow-hidden mt-0 opacity-0 transition-all duration-500" style="height: 0">
        <!-- Additional Categories -->
        <div class="mt-3 flex flex-wrap gap-2" :class="{ 'mt-4': expanded }">
            <template x-for="category in walk.categories?.slice(3)" :key="category.slug">
                <span class="category-tag inline-flex items-center px-2.5 py-1 
                            rounded-full text-xs font-medium bg-primary-50/50 
                            text-primary-700 pointer-events-none
                            transition-all duration-300">
                    <span x-text="category.name"></span>
                </span>
            </template>
        </div>

        <!-- Description -->
        <div class="highlights mt-3 text-sm text-gray-600 leading-relaxed" :class="{ 'mt-4': expanded }">
            <p x-text="walk.description || walk.highlights" class="pointer-events-none"></p>
        </div>

        <!-- Walk Details Grid -->
        <div class="mt-3 grid grid-cols-2 gap-4 text-sm text-gray-600" :class="{ 'mt-4': expanded }">
            <div class="pointer-events-none">
                <span class="font-medium">{% translate "Duration" %}:</span>
                <span x-text="walk.duration"></span>
            </div>
            <div class="pointer-events-none">
                <span class="font-medium">{% translate "Elevation" %}:</span>
                <span x-text="`${walk.elevation_gain || 0}m`"></span>
            </div>
        </div>
    </div>

    <!-- Features Icons -->
    <div class="mt-2 flex flex-wrap gap-3 text-xs text-gray-500" :class="{ 'mt-4': expanded }">
        <template x-if="walk.has_pub">
            <span class="inline-flex items-center pointer-events-none">
                <iconify-icon icon="mdi:beer" class="w-4 h-4 mr-1"></iconify-icon>
                {% translate "Pub Stop" %}
            </span>
        </template>
        <template x-if="walk.has_cafe">
            <span class="inline-flex items-center pointer-events-none">
                <iconify-icon icon="mdi:coffee" class="w-4 h-4 mr-1"></iconify-icon>
                {% translate "Café Stop" %}
            </span>
        </template>
        <template x-if="walk.has_bus_access">
            <span class="inline-flex items-center pointer-events-none">
                <iconify-icon icon="mdi:bus" class="w-4 h-4 mr-1"></iconify-icon>
                {% translate "Bus Access" %}
            </span>
        </template>
        <template x-if="walk.has_parking">
            <span class="inline-flex items-center pointer-events-none">
                <iconify-icon icon="mdi:parking" class="w-4 h-4 mr-1"></iconify-icon>
                {% translate "Parking" %}
            </span>
        </template>
    </div>
</div>