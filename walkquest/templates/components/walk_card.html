{% load slippers %}
{% load i18n %}

<div class="walk-item p-4 backdrop-blur-md rounded-xl shadow-sm hover:shadow-lg 
            transition-all duration-300 ease-out cursor-pointer 
            border border-white/20 hover:border-primary-200/50 
            bg-white/5 hover:bg-white/10 group relative overflow-hidden"
     :class="{
         'expanded': expanded,
         'selected': $store.walks.selectedWalk?.id === walk.id,
         'favorite': walk.is_favorite,
         'pending': $store.walks.pendingFavorites.has(walk.id)
     }" 
     :key="walk.id"
     x-data="{ 
         expanded: false,
         walk: walk,
         toggleExpand(event) {
             if (event.target.closest('.favorite-btn')) return;
             this.expanded = !this.expanded;
             if (this.expanded && $store.walks) {
                 $store.walks.setSelectedWalk(this.walk);
             }
         }
     }"
     @click="toggleExpand($event)"
     @keydown.space.prevent="toggleExpand($event)"
     @keydown.enter.prevent="toggleExpand($event)">
     
    <!-- Accessibility overlay -->
    <div class="absolute inset-0 bg-transparent opacity-0 group-hover:opacity-10 transition-opacity duration-300" 
         :class="{ 'opacity-10': $store.walks.selectedWalk?.id === walk.id }">
        <div class="absolute top-0 left-0 w-full h-full bg-white/50 backdrop-blur-lg"></div>
    </div>

    <!-- Header Section -->
    <div class="flex justify-between items-start gap-4 mb-4">
        <!-- Title Section with proper pointer events -->
        <div class="flex-1 pointer-events-none">
            <h3 class="text-xl font-semibold text-gray-900 group-hover:text-primary-900 
                       transition-colors duration-200"
                :class="{ 'text-2xl': expanded }"
                x-text="walk.walk_name"></h3>
            
            <!-- Basic Info Row -->
            <div class="mt-1.5 flex items-center gap-3 text-sm text-gray-600">
                <span class="flex items-center">
                    <iconify-icon icon="mdi:map-marker-distance" class="w-4 h-4 mr-1"></iconify-icon>
                    <span x-text="`${walk.distance?.toFixed(1) || 0} miles`"></span>
                </span>
                <span class="flex items-center">
                    <iconify-icon icon="mdi:mountain" class="w-4 h-4 mr-1"></iconify-icon>
                    <span x-text="walk.steepness_level || 'Easy'"></span>
                </span>
            </div>
        </div>

        <!-- Favorite Button with isolated click handling -->
        <button class="favorite-btn p-2.5 rounded-full hover:bg-white/10 
                       transition-colors duration-200 pointer-events-auto
                       absolute top-2 right-2"
                @click.stop="$dispatch('toggle-favorite', { walkId: walk.id })"
                :aria-label="walk.is_favorite ? 'Remove from favorites' : 'Add to favorites'"
                :class="{ 'text-red-500': walk.is_favorite }">
            <iconify-icon icon="mdi:heart" class="w-6 h-6"></iconify-icon>
        </button>
    </div>

    <!-- Primary Categories -->
    <div class="mb-4 flex flex-wrap gap-2">
        <template x-for="category in walk.categories?.slice(0, 3)" :key="category.slug">
            <span class="category-tag inline-flex items-center px-3 py-1.5 
                        rounded-full text-sm font-medium bg-primary-50/50 
                        text-primary-700 pointer-events-none
                        transition-all duration-300 hover:bg-primary-50/70">
                <span x-text="category.name"></span>
            </span>
        </template>
    </div>

    <!-- Expandable Content -->
    <div class="expandable-content overflow-hidden mt-0 opacity-0 transition-all duration-500" style="height: 0">
        <!-- Additional Categories -->
        <div class="mb-4 flex flex-wrap gap-2">
            <template x-for="category in walk.categories?.slice(3)" :key="category.slug">
                <span class="category-tag inline-flex items-center px-3 py-1.5 
                            rounded-full text-sm font-medium bg-primary-50/50 
                            text-primary-700 pointer-events-none
                            transition-all duration-300 hover:bg-primary-50/70">
                    <span x-text="category.name"></span>
                </span>
            </template>
        </div>

        <!-- Description -->
        <div class="highlights mb-4 text-sm text-gray-600 leading-relaxed">
            <p x-text="walk.description || walk.highlights" class="pointer-events-none"></p>
        </div>

        <!-- Walk Details Grid -->
        <div class="mb-4 grid grid-cols-2 gap-4 text-sm text-gray-600">
            <div class="pointer-events-none">
                <span class="font-medium">{% translate "Duration" %}:</span>
                <span x-text="walk.duration"></span>
            </div>
            <div class="pointer-events-none">
                <span class="font-medium">{% translate "Elevation" %}:</span>
                <span x-text="`${walk.elevation_gain || 0}m`"></span>
            </div>
        </div>

        <!-- Features Icons -->
        <div class="flex flex-wrap gap-4 text-sm text-gray-500">
            <template x-if="walk.has_pub">
                <span class="inline-flex items-center pointer-events-none">
                    <iconify-icon icon="mdi:beer" class="w-5 h-5 mr-1"></iconify-icon>
                    {% translate "Pub Stop" %}
                </span>
            </template>
            <template x-if="walk.has_cafe">
                <span class="inline-flex items-center pointer-events-none">
                    <iconify-icon icon="mdi:coffee" class="w-5 h-5 mr-1"></iconify-icon>
                    {% translate "CafÃ© Stop" %}
                </span>
            </template>
            <template x-if="walk.has_bus_access">
                <span class="inline-flex items-center pointer-events-none">
                    <iconify-icon icon="mdi:bus" class="w-5 h-5 mr-1"></iconify-icon>
                    {% translate "Bus Access" %}
                </span>
            </template>
            <template x-if="walk.has_parking">
                <span class="inline-flex items-center pointer-events-none">
                    <iconify-icon icon="mdi:parking" class="w-5 h-5 mr-1"></iconify-icon>
                    {% translate "Parking" %}
                </span>
            </template>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="mt-4 flex gap-2">
        <button class="px-4 py-2 rounded-lg bg-primary-500 text-white 
                       hover:bg-primary-600 transition-colors duration-200
                       pointer-events-auto"
                @click="$dispatch('view-details', { walkId: walk.id })">
            {% translate "View Details" %}
        </button>
        <button class="px-4 py-2 rounded-lg border border-primary-500 text-primary-500 
                       hover:bg-primary-50/10 transition-colors duration-200
                       pointer-events-auto"
                @click="toggleExpand($event)">
            <span x-text="expanded ? 'Hide Details' : 'Show Details'"></span>
        </button>
    </div>
</div>
