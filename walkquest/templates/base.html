{% load static i18n compress%}<!DOCTYPE html>
{% get_current_language as LANGUAGE_CODE %}
<html lang="{{ LANGUAGE_CODE }}">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>
      {% block title %}
      walkquest
      {% endblock title %}
    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Walk in the quest!" />
    <meta name="author" content="Andrea Maestri" />
    <link rel="icon" href="{% static 'images/favicons/favicon.ico' %}" />
    
    {% block css %}
    <!-- Use latest Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#1D4ED8',
              secondary: '#9333EA',
            },
            spacing: {
              '128': '32rem',
            },
          },
        },
      }
    </script>
    {% compress css %}
    <link href="{% static 'css/project.css' %}" rel="stylesheet" />
    {% endcompress %}

    <!-- Mapbox CSS must be after our custom CSS -->
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css' rel='stylesheet' />
    {% endblock css %}
    
    {% block javascript %}
    <!-- Scripts loading and error handling -->
    <script>
        window.handleScriptError = function(error) {
            console.error('Script loading error:', error);
            document.body.innerHTML = `
                <div class="p-4 bg-red-100 text-red-700">
                    Failed to load required scripts. Please refresh the page or contact support.
                </div>
            `;
        }
    </script>

    <!-- Load Dependencies -->
    <script>
        window.depsLoaded = {
            solidJs: false,
            mapboxGl: false,
            iconify: false
        };
        
        function initDependencies() {
            Promise.all([
                // Load SolidJS
                Promise.all([
                    import('https://cdn.skypack.dev/solid-js@1.7.11'),
                    import('https://cdn.skypack.dev/solid-js@1.7.11/web'),
                    import('https://cdn.skypack.dev/solid-js@1.7.11/html')
                ]).then(([solid, solidWeb, html]) => {
                    window.solidJs = solid;
                    window.solidJsWeb = solidWeb;
                    window.html = html.default;
                    window.depsLoaded.solidJs = true;
                    console.log('SolidJS loaded successfully');
                }),
                // Load Mapbox
                import('https://cdn.skypack.dev/mapbox-gl').then(mapboxModule => {
                    window.mapboxgl = mapboxModule.default;
                    window.depsLoaded.mapboxGl = true;
                    console.log('Mapbox GL loaded successfully');
                }),
                // Load Iconify for Solid
                import('https://cdn.skypack.dev/@iconify-icon/solid').then(iconifyModule => {
                    window.Icon = iconifyModule.Icon;
                    window.depsLoaded.iconify = true;
                    console.log('Iconify for Solid loaded successfully');
                })
            ]).then(() => {
                window.dispatchEvent(new Event('deps-loaded'));
            }).catch(error => {
                console.error('Failed to load dependencies:', error);
                handleScriptError(error);
            });
        }

        // Initialize dependencies loading
        initDependencies();
    </script>

    {{ form.media }}
    <script src="{% static 'tinymce/tinymce.min.js' %}"></script>

    {% compress js %}
    <script defer src="{% static 'js/project.js' %}"></script>
    {% endcompress %}
    {% endblock javascript %}
  </head>
  <body class="bg-gray-100">
    <nav class="bg-white shadow-sm fixed top-0 left-0 right-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-12">
                <div class="flex">
                    <a href="{% url 'home' %}" class="flex-shrink-0 flex items-center">
                        WalkQuest
                    </a>
                </div>
                <div class="flex items-center">
                    {% if request.user.is_authenticated %}
                        <a href="{% url 'users:detail' request.user.username %}" 
                           class="px-4 py-1.5 rounded text-sm font-medium text-primary hover:bg-blue-50">Profile</a>
                        <a href="{% url 'account_logout' %}" 
                           class="px-4 py-1.5 rounded text-sm font-medium text-primary hover:bg-blue-50">Sign out</a>
                    {% else %}
                        <a href="{% url 'account_login' %}" 
                           class="px-4 py-1.5 rounded text-sm font-medium text-primary hover:bg-blue-50">Sign in</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    {% block body %}
    {% if messages %}
    {% for message in messages %}
    <div class="relative px-4 py-3 {% if message.tags %}{% if message.tags == 'success' %}bg-green-100 text-green-700{% elif message.tags == 'error' %}bg-red-100 text-red-700{% elif message.tags == 'info' %}bg-blue-100 text-blue-700{% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-700{% endif %}{% endif %} rounded mb-4">
        {{ message }}
        <button type="button" class="absolute top-0 right-0 px-4 py-3" onclick="this.parentElement.remove()">
          <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 20 20">
            <path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" fill-rule="evenodd"></path>
          </svg>
        </button>
    </div>
    {% endfor %}
    {% endif %}
    {% block content %}{% endblock content %}
    {% endblock body %}
    {% block modal %}{% endblock modal %}
    {% block inline_javascript %}{% endblock inline_javascript %}
    {% block extra_js %}{% endblock extra_js %}
  </body>
</html>
