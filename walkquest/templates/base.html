{% load static i18n compress %}
<!DOCTYPE html>
{% get_current_language as LANGUAGE_CODE %}
<html lang="{{ LANGUAGE_CODE }}">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <title>
      {% block title %}walkquest{% endblock title %}
    </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Walk in the quest!" />
    <meta name="author" content="Andrea Maestri" />
    <link rel="icon" href="{% static 'images/favicons/favicon.ico' %}" />
    
    {# CSS Section #}
    {% block css %}
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: '#1D4ED8',
              secondary: '#9333EA',
            },
            spacing: {
              '128': '32rem',
            },
          },
        },
      }
    </script>
    {% compress css %}
    <link href="{% static 'css/project.css' %}" rel="stylesheet" />
    <link href="{% static 'css/sidebar.css' %}" rel="stylesheet" />
    {% endcompress %}

    <link href='https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css' rel='stylesheet' />
    {% endblock css %}
    
    {# JavaScript Dependencies #}
    {% block javascript %}
    <script type="importmap">
    {
        "imports": {
            "solid-js": "https://cdn.skypack.dev/solid-js@1.9.3",
            "solid-js/web": "https://cdn.skypack.dev/solid-js@1.9.3/web",
            "@iconify/iconify": "https://cdn.skypack.dev/@iconify/iconify@3.1.1",
            "iconify-icon": "https://cdn.skypack.dev/iconify-icon@2.1.0",
            "mapbox-gl": "https://cdn.skypack.dev/mapbox-gl@3.8.0"
        }
    }
    </script>

    <script type="module">
      // Initialize dependencies
      window.depsLoaded = new Promise(async (resolve, reject) => {
          try {
              const [solid, solidWeb, iconify, mapboxgl] = await Promise.all([
                  import('solid-js'),
                  import('solid-js/web'),
                  import('@iconify/iconify'),
                  import('mapbox-gl')
              ]);

              // Set up global SolidJS object
              window.solidJs = {
                  ...solid,
                  ...solidWeb,
                  createSignal: solid.createSignal,
                  createEffect: solid.createEffect,
                  onMount: solid.onMount,
                  onCleanup: solid.onCleanup,
                  render: solidWeb.render
              };

              window.mapboxgl = mapboxgl.default;
              window.Iconify = iconify.default;

              await import('iconify-icon');
              
              console.log('Dependencies loaded successfully');
              resolve();
          } catch (error) {
              console.error('Failed to load dependencies:', error);
              reject(error);
          }
      });
    </script>

    {{ form.media }}

    {% compress js %}
    <script defer src="{% static 'js/project.js' %}"></script>
    {% endcompress %}
    {% endblock javascript %}
  </head>

  <body class="bg-gray-100">
    {# Navigation #}
    <nav class="bg-white shadow-sm fixed top-0 left-0 right-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between h-12">
                <div class="flex">
                    <a href="{% url 'home' %}" class="flex-shrink-0 flex items-center">
                        WalkQuest
                    </a>
                </div>
                <div class="flex items-center">
                    {% if request.user.is_authenticated %}
                        <a href="{% url 'users:detail' request.user.username %}" 
                           class="px-4 py-1.5 rounded text-sm font-medium text-primary hover:bg-blue-50">
                           Profile
                        </a>
                        <a href="{% url 'account_logout' %}" 
                           class="px-4 py-1.5 rounded text-sm font-medium text-primary hover:bg-blue-50">
                           Sign out
                        </a>
                    {% else %}
                        <a href="{% url 'account_login' %}" 
                           class="px-4 py-1.5 rounded text-sm font-medium text-primary hover:bg-blue-50">
                           Sign in
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    {# Main Content #}
    {% block body %}
      {% if messages %}
        {% for message in messages %}
          <div class="relative px-4 py-3 {% if message.tags %}{% if message.tags == 'success' %}bg-green-100 text-green-700{% elif message.tags == 'error' %}bg-red-100 text-red-700{% elif message.tags == 'info' %}bg-blue-100 text-blue-700{% elif message.tags == 'warning' %}bg-yellow-100 text-yellow-700{% endif %}{% endif %} rounded mb-4">
              {{ message }}
              <button type="button" class="absolute top-0 right-0 px-4 py-3" onclick="this.parentElement.remove()">
                <svg class="h-6 w-6" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" fill-rule="evenodd"></path>
                </svg>
              </button>
          </div>
        {% endfor %}
      {% endif %}
      {% block content %}{% endblock content %}
    {% endblock body %}

    {% block modal %}{% endblock modal %}
    {% block inline_javascript %}{% endblock inline_javascript %}
    {% block extra_js %}{% endblock extra_js %}
  </body>
</html>