{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}{% translate "Walks" %} - {{ block.super }}{% endblock %}

{% block content %}
<div id="walks-app" class="h-full">
    <!-- React will render here -->
</div>
{% endblock %}

{% block extra_javascript %}
<script type="module">
    import React, { useState, useEffect, useRef } from 'react';
    import { createRoot } from 'react-dom/client';

    const WalkItem = React.memo(({ walk, onSelect }) => {
        return React.createElement('div', {
            className: "walk-item p-4 border-b hover:bg-gray-100",
            onClick: () => onSelect(walk)
        }, [
            React.createElement('h3', { key: 'title', className: "font-semibold" }, walk.walk_name),
            React.createElement('div', { key: 'distance', className: "text-sm text-gray-600" }, 
                `${(walk.distance / 1000).toFixed(1)}km`
            )
        ]);
    });

    const WalksApp = () => {
        const [walks, setWalks] = useState([]);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [map, setMap] = useState(null);
        const mapContainer = useRef(null);

        useEffect(() => {
            if (!mapContainer.current) return;

            const mapInstance = new maplibregl.Map({
                container: mapContainer.current,
                style: 'https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json',
                center: [-4.85, 50.4],
                zoom: 9.5
            });

            setMap(mapInstance);

            return () => mapInstance.remove();
        }, [mapContainer.current]);

        useEffect(() => {
            const fetchWalks = async () => {
                try {
                    const response = await fetch('/api/walks', {
                        headers: {
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('Fetched data:', data); // Debug log
                    setWalks(Array.isArray(data) ? data : []);
                    setError(null);
                } catch (error) {
                    console.error('Error fetching walks:', error);
                    setError('Failed to load walks');
                    setWalks([]);
                } finally {
                    setLoading(false);
                }
            };

            fetchWalks();
        }, []);

        if (loading) {
            return React.createElement('div', { className: "p-4" }, "Loading walks...");
        }

        if (error) {
            return React.createElement('div', { className: "p-4 text-red-600" }, error);
        }

        return React.createElement('div', { className: "flex h-full" }, [
            React.createElement('div', { 
                key: 'sidebar', 
                className: "w-1/4 bg-gray-100 p-4 overflow-y-auto" 
            }, 
                walks.map(walk => 
                    React.createElement(WalkItem, { 
                        key: walk.id, 
                        walk: walk, 
                        onSelect: () => console.log('Selected:', walk.walk_name)
                    })
                )
            ),
            React.createElement('div', { 
                key: 'map', 
                ref: mapContainer,
                className: "flex-1"
            })
        ]);
    };

    // Initialize React app
    document.addEventListener('DOMContentLoaded', () => {
        const container = document.getElementById('walks-app');
        if (container) {
            const root = createRoot(container);
            root.render(React.createElement(WalksApp));
        }
    });
</script>
{% endblock %}