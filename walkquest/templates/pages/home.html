{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="relative w-full h-screen">
    <!-- Search box -->
    <div class="absolute top-4 left-1/2 transform -translate-x-1/2 z-10 w-1/3">
        <input type="text" id="search" 
               class="w-full px-4 py-2 rounded-lg shadow-lg border-0 focus:ring-2 focus:ring-blue-500" 
               placeholder="Search walks...">
    </div>

    <!-- Side panel (hidden by default) -->
    <div id="side-panel" class="hidden absolute left-0 top-0 w-96 h-full bg-white shadow-lg z-20 overflow-y-auto">
        <div class="p-4">
            <button id="close-panel" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <div id="panel-content"></div>
        </div>
    </div>

    <!-- Map -->
    <div id="map" class="w-full h-full"></div>
</div>
{% endblock %}

{% block extra_js %}
<link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
<script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>

<script>
    const map = new maplibregl.Map({
        container: 'map',
        style: {
            version: 8,
            sources: {
                'osm': {
                    type: 'raster',
                    tiles: ['{{ map_tile_url }}'],
                    tileSize: 256,
                    attribution: '{{ map_attribution }}'
                }
            },
            layers: [{
                id: 'osm',
                type: 'raster',
                source: 'osm',
                minzoom: 0,
                maxzoom: 18
            }]
        },
        center: [-4.4726, 50.5155],
        zoom: 9
    });

    // Add navigation controls
    map.addControl(new maplibregl.NavigationControl(), 'top-right');

    // Store all walks data
    const walks = [
        {% for walk in walks %}
            {
                id: '{{ walk.walk_id }}',
                title: '{{ walk.title }}',
                description: '{{ walk.description|truncatewords:30|escapejs }}',
                distance: '{{ walk.distance }}',
                coordinates: [{{ walk.longitude }}, {{ walk.latitude }}],
                difficulty: '{{ walk.steepness_level }}'
            },
        {% endfor %}
    ];

    // Add markers for each walk
    walks.forEach(walk => {
        // Create marker element
        const el = document.createElement('div');
        el.className = 'marker';
        el.innerHTML = `
            <div class="w-8 h-8 bg-red-500 rounded-full border-2 border-white shadow-lg 
                        flex items-center justify-center text-white cursor-pointer transform hover:scale-110 transition-transform">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9z"/>
                </svg>
            </div>
        `;

        // Add marker
        new maplibregl.Marker(el)
            .setLngLat(walk.coordinates)
            .addTo(map)
            .getElement()
            .addEventListener('click', () => {
                // Open side panel with walk details
                document.getElementById('side-panel').classList.remove('hidden');
                document.getElementById('panel-content').innerHTML = `
                    <h2 class="text-xl font-bold mb-2">${walk.title}</h2>
                    <p class="text-gray-600 mb-4">${walk.description}</p>
                    <div class="mb-4">
                        <span class="font-bold">Distance:</span> ${walk.distance}km
                        <br>
                        <span class="font-bold">Difficulty:</span> ${walk.difficulty}
                    </div>
                    <a href="/walks/${walk.id}" 
                       class="inline-block px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        View Details
                    </a>
                `;
                
                // Fly to marker location
                map.flyTo({
                    center: walk.coordinates,
                    zoom: 14,
                    essential: true
                });
            });
    });

    // Search functionality
    document.getElementById('search').addEventListener('input', (e) => {
        const searchText = e.target.value.toLowerCase();
        const filtered = walks.filter(walk => 
            walk.title.toLowerCase().includes(searchText) || 
            walk.description.toLowerCase().includes(searchText)
        );
        if (filtered.length > 0) {
            // Center map on first result
            map.flyTo({
                center: filtered[0].coordinates,
                zoom: 13,
                essential: true
            });
        }
    });

    // Close panel button
    document.getElementById('close-panel').addEventListener('click', () => {
        document.getElementById('side-panel').classList.add('hidden');
    });
</script>

<style>
    .marker {
        cursor: pointer;
    }
    .maplibregl-popup {
        max-width: 300px;
    }
</style>
{% endblock %}
