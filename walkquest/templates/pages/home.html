{% extends "base.html" %}
{% load static %}

{% block title %}Walks - {{ block.super }}{% endblock %}

{% block css %}
{{ block.super }}
<style>
    script[type="application/json"] { display: none; }
    .sidebar-transition { transition: transform 0.3s ease-in-out; }
    .overflow-container { -webkit-overflow-scrolling: touch; }
</style>
{% endblock %}

{% block content %}
{# App Container #}
<div id="root" class="h-screen w-screen relative">
    <div id="loading" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
        <span class="ml-3">Loading...</span>
    </div>
</div>

{# Data Initialization #}
{{ walks_json|json_script:"walks-data" }}
{{ marker_icons_json|json_script:"marker-icons-data" }}
{{ feature_icons_json|json_script:"feature-icons-data" }}
{{ available_features_json|json_script:"available-features-data" }}
{{ mapbox_token|json_script:"mapbox-token" }}
{% endblock %}

{% block inline_javascript %}
<script type="module">
    // Imports
    import { 
        createSignal, 
        createEffect, 
        onCleanup, 
        onMount, 
        createMemo,
        batch
    } from "https://cdn.skypack.dev/solid-js@1.9.3";
    import { render } from "https://cdn.skypack.dev/solid-js@1.9.3/web";
    import html from "https://cdn.skypack.dev/solid-js@1.9.3/html";
    import mapboxgl from "https://cdn.skypack.dev/mapbox-gl";

    // Constants
    const MAPBOX_STYLE = 'mapbox://styles/mapbox/outdoors-v12';
    const DEFAULT_CENTER = [-4.85, 50.40];
    const DEFAULT_ZOOM = 9;
    const CIRCLE_STYLE = {
        'circle-radius': 8,
        'circle-color': '#4F46E5',
        'circle-stroke-width': 2,
        'circle-stroke-color': '#fff'
    };

    // Utilities
    const safeJSONParse = (id, fallback = null) => {
        try {
            return JSON.parse(document.getElementById(id).textContent);
        } catch (error) {
            console.error(`Error parsing ${id}:`, error);
            return fallback;
        }
    };

    // Initialize Data
    const AppData = {
        walks: safeJSONParse('walks-data', []),
        markerIcons: safeJSONParse('marker-icons-data', {}),
        featureIcons: safeJSONParse('feature-icons-data', {}),
        features: safeJSONParse('available-features-data', []),
        mapboxToken: safeJSONParse('mapbox-token', '')
    };

    // Configure Mapbox
    mapboxgl.accessToken = AppData.mapboxToken;

    // Store
    function createWalkStore() {
        const [walks] = createSignal(AppData.walks);
        const [selectedWalk, setSelectedWalk] = createSignal(null);
        const [searchTerm, setSearchTerm] = createSignal('');
        const [sidebarOpen, setSidebarOpen] = createSignal(true);

        const filteredWalks = createMemo(() => {
            const search = searchTerm().toLowerCase();
            return !search ? walks() : walks().filter(walk => 
                walk.walk_name.toLowerCase().includes(search) || 
                walk.description.toLowerCase().includes(search)
            );
        });

        return {
            walks,
            selectedWalk,
            searchTerm,
            sidebarOpen,
            filteredWalks,
            toggleSidebar: () => setSidebarOpen(prev => !prev),
            setSearchTerm,
            selectWalk: walkId => batch(() => {
                const walk = walks().find(w => w.id === walkId);
                setSelectedWalk(walk);
            })
        };
    }

    // Components
    const WalkItem = ({ walk, store, selected }) => html`
        <div class="p-4 border-b hover:bg-gray-50 cursor-pointer ${selected ? 'bg-blue-50' : ''}"
             onclick=${() => store.selectWalk(walk.id)}>
            <h3 class="text-lg font-semibold">${walk.walk_name}</h3>
            ${walk.distance && html`
                <div class="flex items-center mt-2 text-sm text-gray-600">
                    <iconify-icon icon="mdi:map-marker-distance" class="mr-1"></iconify-icon>
                    ${walk.distance} miles
                </div>
            `}
        </div>
    `;

    const SearchInput = ({ value, onSearch }) => html`
        <input type="text"
               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
               placeholder="Search walks..."
               value=${value}
               oninput=${e => onSearch(e.target.value)} />
    `;

    const Sidebar = ({ store }) => {
        const isOpen = createMemo(() => store.sidebarOpen());
        const walks = createMemo(() => store.filteredWalks());
        const selectedId = createMemo(() => store.selectedWalk()?.id);

        return html`
            <aside class="absolute top-12 transform ${() => isOpen() ? 'translate-x-4' : '-translate-x-full'} 
                         w-[400px] h-[calc(100vh-4rem)] bg-white shadow-lg rounded-lg mt-4
                         sidebar-transition flex flex-col z-10">
                <div class="p-4 border-b">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Available Walks</h2>
                        <button onclick=${() => store.toggleSidebar()}
                                class="p-2 hover:bg-gray-100 rounded-full">
                            <iconify-icon icon="mdi:chevron-left"></iconify-icon>
                        </button>
                    </div>
                    ${SearchInput({
                        value: store.searchTerm(),
                        onSearch: store.setSearchTerm
                    })}
                </div>
                <div class="flex-1 overflow-y-auto overflow-container">
                    ${() => walks().map(walk => 
                        WalkItem({ 
                            walk, 
                            store, 
                            selected: walk.id === selectedId() 
                        })
                    )}
                </div>
            </aside>
        `;
    };

    const Map = ({ store }) => {
        let mapContainer;
        const [error, setError] = createSignal(null);
        const [map, setMap] = createSignal(null);

        const initializeMap = () => {
            if (!mapContainer || !AppData.mapboxToken) {
                setError('Map initialization failed');
                return;
            }

            const mapInstance = new mapboxgl.Map({
                container: mapContainer,
                style: MAPBOX_STYLE,
                center: DEFAULT_CENTER,
                zoom: DEFAULT_ZOOM
            });

            mapInstance.on('load', () => {
                setMap(mapInstance);
                initializeLayers(mapInstance);
            });

            return mapInstance;
        };

        const initializeLayers = (mapInstance) => {
            const walks = store.walks();
            if (!walks.length) return;

            const geojson = {
                type: 'FeatureCollection',
                features: walks.map(walk => ({
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [walk.longitude, walk.latitude]
                    },
                    properties: { id: walk.id }
                }))
            };

            mapInstance.addSource('walks', { type: 'geojson', data: geojson });
            mapInstance.addLayer({
                id: 'walks',
                type: 'circle',
                source: 'walks',
                paint: CIRCLE_STYLE
            });
        };

        onMount(() => {
            const mapInstance = initializeMap();
            onCleanup(() => mapInstance?.remove());
        });

        createEffect(() => {
            const selected = store.selectedWalk();
            const mapInstance = map();
            
            if (selected && mapInstance) {
                mapInstance.flyTo({
                    center: [selected.longitude, selected.latitude],
                    zoom: 14
                });
            }
        });

        return html`
            <div class="flex-1 relative">
                <div ref=${el => mapContainer = el} 
                     class="absolute inset-0">
                </div>
                ${error() && html`
                    <div class="absolute top-4 right-4 bg-red-100 text-red-700 p-4 rounded">
                        ${error()}
                    </div>
                `}
            </div>
        `;
    };

    const App = ({ store }) => html`
        <div class="h-screen w-screen relative overflow-hidden flex">
            ${Map({ store })}
            ${Sidebar({ store })}
        </div>
    `;

    // Initialize app
    function initApp() {
        try {
            if (!AppData.mapboxToken) throw new Error('Mapbox token is not configured');
            if (!Array.isArray(AppData.walks)) throw new Error('Invalid walk data');

            const store = createWalkStore();
            const root = document.getElementById('root');
            
            if (!root) throw new Error('Root element not found');

            render(() => App({ store }), root);
            document.getElementById('loading')?.classList.add('hidden');
        } catch (error) {
            console.error('App initialization failed:', error);
            const loading = document.getElementById('loading');
            if (loading) {
                loading.innerHTML = `
                    <div class="text-red-500">
                        <p class="font-bold">Error:</p>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
    }

    // Start the app
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initApp);
    } else {
        initApp();
    }
</script>
{% endblock %}