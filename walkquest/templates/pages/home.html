{% extends "base.html" %}
{% load i18n %}

{% block title %}{% translate "Walks" %} - {{ block.super }}{% endblock %}

{% block content %}
<div id="walks-app" style="height: 100vh; width: 100%;">
    <!-- React will render here -->
</div>
{% endblock %}

{% block extra_javascript %}
<script type="module">
    import React, { useState, useEffect, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import maplibregl from 'https://esm.run/maplibre-gl';
    import { motion, AnimatePresence } from 'framer-motion';

    const ListContainer = ({ children }) => {
        return React.createElement(motion.div, {
            className: "space-y-4",
            initial: "hidden",
            animate: "visible",
            variants: {
                hidden: { opacity: 0 },
                visible: {
                    opacity: 1,
                    transition: {
                        staggerChildren: 0.1,
                        delayChildren: 0.3
                    }
                }
            }
        }, children);
    };

    const MapComponent = ({ walks, selectedWalk, onWalkSelect }) => {
        const mapContainer = useRef(null);
        const [map, setMap] = useState(null);
        const markersRef = useRef([]); // Define markersRef
        const [walkGeometry, setWalkGeometry] = useState(null);

        const clearMarkers = () => {
            markersRef.current.forEach(marker => marker.remove());
            markersRef.current = [];
        };

        // Expose map instance to parent through callback
        useEffect(() => {
            if (map) {
                onWalkSelect(null, map); // Pass map instance to parent
            }
        }, [map]);

        // Add markers for walks
        useEffect(() => {
            if (!map || !walks) return;

            clearMarkers();

            walks.forEach(walk => {
                if (!walk.latitude || !walk.longitude) return;

                // Create marker HTML element
                const markerEl = document.createElement('div');
                markerEl.className = 'marker';
                
                // Create popup with walk details
                const popupContent = `
                    <div class="p-2">
                        <h3 class="font-bold mb-1">${walk.walk_name}</h3>
                        <p class="text-sm text-gray-600">${(walk.distance / 1000).toFixed(1)}km</p>
                        <div class="flex gap-2 mt-1">
                            ${walk.has_pub ? '<span class="text-xs px-2 py-1 bg-amber-100 rounded">Pub</span>' : ''}
                            ${walk.has_cafe ? '<span class="text-xs px-2 py-1 bg-blue-100 rounded">Café</span>' : ''}
                        </div>
                        ${walk.features.length > 0 ? `
                            <div class="text-xs text-gray-500 mt-1">
                                ${walk.features.map(f => f.name).join(' • ')}
                            </div>
                        ` : ''}
                    </div>
                `;

                const popup = new maplibregl.Popup({ 
                    offset: 25,
                    closeButton: false,
                    maxWidth: '300px'
                }).setHTML(popupContent);

                // Create marker with custom options
                const marker = new maplibregl.Marker({
                    color: walk.has_pub ? '#f59e0b' : '#3b82f6', // Amber for pubs, blue for others
                    scale: 0.8,
                    draggable: false
                })
                    .setLngLat([walk.longitude, walk.latitude])
                    .setPopup(popup)
                    .addTo(map);

                // Add click handler to marker
                marker.getElement().addEventListener('click', () => {
                    onWalkSelect(walk, map);
                });

                // Show popup on hover
                marker.getElement().addEventListener('mouseenter', () => {
                    if (selectedWalk?.id !== walk.id) {
                        marker.togglePopup();
                    }
                });

                marker.getElement().addEventListener('mouseleave', () => {
                    if (selectedWalk?.id !== walk.id) {
                        marker.togglePopup();
                    }
                });
                
                markersRef.current.push(marker);
            });

            // Fit bounds if we have markers
            if (markersRef.current.length > 0) {
                const bounds = new maplibregl.LngLatBounds();
                walks.forEach(walk => {
                    if (walk.latitude && walk.longitude) {
                        bounds.extend([walk.longitude, walk.latitude]);
                    }
                });
                map.fitBounds(bounds, { 
                    padding: 50,
                    maxZoom: 15 
                });
            }
        }, [map, walks, selectedWalk]);

        // Initial map setup
        useEffect(() => {
            console.log('MapComponent mounted, container:', mapContainer.current);
            
            if (!mapContainer.current) return;

            try {
                console.log('Initializing map...');
                const mapInstance = new maplibregl.Map({
                    container: mapContainer.current,
                    style: 'https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json',
                    center: [-4.85, 50.4],
                    zoom: 9.5
                });

                mapInstance.on('load', () => {
                    console.log('Map loaded successfully');
                });

                setMap(mapInstance);

                return () => {
                    console.log('Cleaning up map');
                    mapInstance.remove();
                };
            } catch (error) {
                console.error('Error initializing map:', error);
            }
        }, []);

        // Update geometry fetching function to use walk_id
        const fetchWalkGeometry = async (id) => {
            try {
                if (!id) {
                    console.error('No walk ID provided');
                    return null;
                }

                console.log('Fetching geometry for walk:', id);
                const response = await fetch(`/api/walks/${id}/geometry`, {
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (!response.ok) throw new Error(`Failed to fetch geometry: ${response.status}`);
                
                const data = await response.json();
                if (!data.geometry) {
                    console.error('No geometry data in response:', data);
                    return null;
                }
                return JSON.parse(data.geometry);
            } catch (error) {
                console.error('Error fetching walk geometry:', error);
                return null;
            }
        };

        // Update path rendering for selected walk
        useEffect(() => {
            if (!map || !selectedWalk || !selectedWalk.id) {
                console.log('Missing required data for path rendering:', {
                    hasMap: !!map,
                    hasSelectedWalk: !!selectedWalk,
                    walkId: selectedWalk?.id
                });
                return;
            }

            const loadWalkPath = async () => {
                console.log('Loading path for walk:', selectedWalk.id);
                // Remove existing path layer
                if (map.getSource('walk-path')) {
                    map.removeLayer('walk-path-layer');
                    map.removeSource('walk-path');
                }

                // Fetch and render new path using the correct id field
                const geometry = await fetchWalkGeometry(selectedWalk.id);
                if (!geometry) return;

                try {
                    map.addSource('walk-path', {
                        'type': 'geojson',
                        'data': {
                            'type': 'Feature',
                            'properties': {},
                            'geometry': geometry
                        }
                    });

                    // Add path layer with improved styling
                    map.addLayer({
                        'id': 'walk-path-layer',
                        'type': 'line',
                        'source': 'walk-path',
                        'layout': {
                            'line-join': 'round',
                            'line-cap': 'round'
                        },
                        'paint': {
                            'line-color': '#3b82f6',
                            'line-width': [
                                'interpolate',
                                ['linear'],
                                ['zoom'],
                                12, 2,
                                16, 4
                            ],
                            'line-opacity': 0.8
                        }
                    });

                    // Add direction arrows
                    map.addLayer({
                        'id': 'walk-direction-layer',
                        'type': 'symbol',
                        'source': 'walk-path',
                        'layout': {
                            'symbol-placement': 'line',
                            'symbol-spacing': 100,
                            'text-field': '→',
                            'text-size': 20,
                            'text-keep-upright': true,
                            'text-offset': [0, 0.5]
                        },
                        'paint': {
                            'text-color': '#2563eb',
                            'text-halo-color': '#ffffff',
                            'text-halo-width': 2
                        }
                    });

                    // Fit bounds to show entire path
                    const bounds = new maplibregl.LngLatBounds();
                    geometry.coordinates.forEach(coord => bounds.extend(coord));
                    
                    map.fitBounds(bounds, {
                        padding: { top: 50, bottom: 50, left: 50, right: 50 },
                        duration: 1000
                    });

                } catch (error) {
                    console.error('Error rendering walk path:', error);
                }
            };

            loadWalkPath();

            return () => {
                if (map.getSource('walk-path')) {
                    map.removeLayer('walk-direction-layer');
                    map.removeLayer('walk-path-layer');
                    map.removeSource('walk-path');
                }
            };
        }, [map, selectedWalk]);

        return React.createElement('div', {
            ref: mapContainer,
            className: "w-full h-full bg-gray-200",
            style: { minHeight: '500px' }
        });
    };

    const IconBadge = ({ icon, text, color = "gray", className = "" }) => {
        return React.createElement(motion.span, {
            className: `inline-flex items-center gap-1 text-xs px-2 py-1 bg-${color}-100 text-${color}-700 rounded-full font-medium ${className}`,
            whileHover: { scale: 1.1 },
            whileTap: { scale: 0.95 }
        }, [
            React.createElement('iconify-icon', {
                key: 'icon',
                icon: icon,
                width: "16",
                height: "16"
            }),
            text
        ]);
    };

    const DetailSection = ({ title, icon, children }) => {
        return React.createElement('div', {
            className: "space-y-2"
        }, [
            React.createElement('h4', { 
                className: "text-sm font-semibold flex items-center gap-2" 
            }, [
                React.createElement('iconify-icon', { icon }),
                title
            ]),
            children
        ]);
    };

    const WalkItem = React.memo(({ walk, onSelect, isSelected }) => {
        const mainFeatures = [
            { icon: 'mdi:hiking', text: `${(walk.distance / 1000).toFixed(1)}km` },
            walk.has_pub && { icon: 'mdi:beer', text: 'Pub', color: 'amber' },
            walk.has_cafe && { icon: 'mdi:coffee', text: 'Café', color: 'blue' }
        ].filter(Boolean);

        const accessibilityFeatures = [
            walk.has_stiles && { icon: 'mdi:gate', text: 'Has Stiles', color: 'orange' },
            walk.has_bus_access && { icon: 'mdi:bus', text: 'Bus Access', color: 'green' }
        ].filter(Boolean);

        return React.createElement(motion.div, {
            className: `walk-item p-4 rounded-lg ${isSelected ? 'bg-blue-50 border border-blue-200' : 'bg-white shadow-sm'}`,
            variants: {
                hidden: { opacity: 0, y: 20, scale: 0.9 },
                visible: { 
                    opacity: 1, 
                    y: 0,
                    scale: 1,
                    transition: {
                        type: "spring",
                        stiffness: 100,
                        damping: 15
                    }
                }
            },
            whileHover: { scale: 1.02 },
            whileTap: { scale: 0.98 },
            onClick: () => onSelect(walk),
            layout: true
        }, [
            // Header with name and favorite status
            React.createElement('div', { 
                key: 'header',
                className: "flex items-start justify-between gap-2 mb-3"
            }, [
                React.createElement('h3', { 
                    className: "font-semibold text-lg flex-1"
                }, walk.walk_name),
                React.createElement(motion.button, {
                    className: `text-xl ${walk.is_favorite ? 'text-yellow-500' : 'text-gray-400'}`,
                    whileHover: { scale: 1.2 },
                    whileTap: { scale: 0.9 }
                }, [
                    React.createElement('iconify-icon', {
                        icon: walk.is_favorite ? 'mdi:star' : 'mdi:star-outline'
                    })
                ])
            ]),

            // Main features row (distance, pub, cafe)
            React.createElement('div', {
                key: 'main-features',
                className: "flex flex-wrap items-center gap-2 mb-3"
            }, mainFeatures.map((feature, index) => 
                React.createElement(IconBadge, {
                    key: index,
                    ...feature
                })
            )),

            // Expanded Details
            isSelected && React.createElement(motion.div, {
                key: 'details',
                initial: { opacity: 0, height: 0 },
                animate: { opacity: 1, height: 'auto' },
                exit: { opacity: 0, height: 0 },
                className: "mt-4 pt-4 border-t space-y-6"
            }, [
                // Walk Info Section
                React.createElement(DetailSection, {
                    title: "Walk Information",
                    icon: "mdi:information"
                }, [
                    React.createElement('div', { className: "space-y-2 text-sm" }, [
                        React.createElement('p', { className: "text-gray-600" }, walk.highlights),
                        walk.points_of_interest && React.createElement('p', { className: "text-gray-600" }, walk.points_of_interest),
                        walk.os_explorer_reference && React.createElement('p', { 
                            className: "flex items-center gap-2 text-gray-500"
                        }, [
                            React.createElement('iconify-icon', { icon: "mdi:map" }),
                            `OS Explorer Map: ${walk.os_explorer_reference}`
                        ])
                    ])
                ]),

                // Difficulty & Requirements
                React.createElement(DetailSection, {
                    title: "Difficulty & Requirements",
                    icon: "mdi:hiking"
                }, [
                    React.createElement('div', { className: "flex flex-wrap gap-2" }, [
                        React.createElement(IconBadge, {
                            icon: "mdi:elevation-rise",
                            text: walk.steepness_level,
                            color: "red"
                        }),
                        React.createElement(IconBadge, {
                            icon: "mdi:shoe-print",
                            text: walk.footwear_category,
                            color: "blue"
                        }),
                        ...accessibilityFeatures.map((feature, index) => 
                            React.createElement(IconBadge, {
                                key: index,
                                ...feature
                            })
                        )
                    ]),
                    React.createElement('p', { 
                        className: "mt-2 text-sm text-gray-600" 
                    }, walk.recommended_footwear)
                ]),

                // Trail Considerations
                React.createElement(DetailSection, {
                    title: "Trail Notes",
                    icon: "mdi:note-text"
                }, [
                    React.createElement('div', { 
                        className: "prose prose-sm text-gray-600" 
                    }, [
                        React.createElement('p', null, walk.trail_considerations),
                        React.createElement('p', { 
                            className: "mt-2 italic text-gray-500" 
                        }, walk.rewritten_trail_considerations)
                    ])
                ]),

                // Pubs List (if available)
                walk.pubs_list?.length > 0 && React.createElement(DetailSection, {
                    title: "Pubs Along the Way",
                    icon: "mdi:beer"
                }, 
                    React.createElement('div', { 
                        className: "grid gap-2" 
                    }, walk.pubs_list.map((pub, index) => 
                        React.createElement('div', {
                            key: index,
                            className: "bg-amber-50 p-2 rounded-lg"
                        }, [
                            React.createElement('span', { 
                                className: "font-medium" 
                            }, pub.name),
                            pub.description && React.createElement('p', { 
                                className: "text-sm text-gray-600" 
                            }, pub.description)
                        ])
                    ))
                ),

                // Categories and Features (existing code with updated styling)
                walk.features.length > 0 && React.createElement('div', {
                    className: "space-y-2"
                }, [
                    React.createElement('h4', { 
                        className: "text-sm font-semibold flex items-center gap-2" 
                    }, [
                        React.createElement('iconify-icon', { icon: 'mdi:map-marker-path' }),
                        "Trail Features"
                    ]),
                    React.createElement('div', { 
                        className: "flex flex-wrap gap-2" 
                    }, walk.features.map(feature => 
                        React.createElement(IconBadge, {
                            key: feature.slug,
                            icon: 'mdi:trail-sign',
                            text: feature.name,
                            color: 'green'
                        })
                    ))
                ]),
                
                // Categories with icons
                walk.categories.length > 0 && React.createElement('div', {
                    className: "space-y-2"
                }, [
                    React.createElement('h4', { 
                        className: "text-sm font-semibold flex items-center gap-2" 
                    }, [
                        React.createElement('iconify-icon', { icon: 'mdi:tag-multiple' }),
                        "Categories"
                    ]),
                    React.createElement('div', { 
                        className: "flex flex-wrap gap-2" 
                    }, walk.categories.map(cat => 
                        React.createElement(IconBadge, {
                            key: cat.slug,
                            icon: 'mdi:tag',
                            text: cat.name,
                            color: 'purple'
                        })
                    ))
                ]),

                // Related Categories
                walk.related_categories?.length > 0 && React.createElement('div', {
                    className: "space-y-2"
                }, [
                    React.createElement('h4', { 
                        className: "text-sm font-semibold flex items-center gap-2" 
                    }, [
                        React.createElement('iconify-icon', { icon: 'mdi:tag-plus' }),
                        "Similar Walks"
                    ]),
                    React.createElement('div', { 
                        className: "flex flex-wrap gap-2" 
                    }, walk.related_categories.map(cat => 
                        React.createElement(IconBadge, {
                            key: cat.slug,
                            icon: 'mdi:tag-outline',
                            text: cat.name,
                            color: 'pink'
                        })
                    ))
                ]),

                // Metadata
                React.createElement('div', {
                    className: "text-xs text-gray-400 flex flex-wrap gap-x-4 gap-y-1 mt-4 pt-4 border-t"
                }, [
                    React.createElement('span', null, [
                        React.createElement('iconify-icon', { 
                            icon: "mdi:identifier",
                            className: "mr-1"
                        }),
                        `ID: ${walk.walk_id}`
                    ]),
                    React.createElement('span', null, [
                        React.createElement('iconify-icon', { 
                            icon: "mdi:calendar",
                            className: "mr-1"
                        }),
                        `Created: ${new Date(walk.created_at).toLocaleDateString()}`
                    ]),
                    React.createElement('span', null, [
                        React.createElement('iconify-icon', { 
                            icon: "mdi:update",
                            className: "mr-1"
                        }),
                        `Updated: ${new Date(walk.updated_at).toLocaleDateString()}`
                    ])
                ])
            ])
        ]);
    });

    const WalksApp = () => {
        const [walks, setWalks] = useState([]);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [selectedWalk, setSelectedWalk] = useState(null);
        const [mapInstance, setMapInstance] = useState(null);
        const markersRef = useRef([]); // Define markersRef

        useEffect(() => {
            const fetchWalks = async () => {
                try {
                    const response = await fetch('/api/walks', {
                        headers: {
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('Fetched data:', data); // Debug log
                    setWalks(Array.isArray(data) ? data : []);
                    setError(null);
                } catch (error) {
                    console.error('Error fetching walks:', error);
                    setError('Failed to load walks');
                    setWalks([]);
                } finally {
                    setLoading(false);
                }
            };

            fetchWalks();
        }, []);

        // Modified handleWalkSelect to accept map instance
        const handleWalkSelect = (walk, map = mapInstance) => {
            setSelectedWalk(walk?.id === selectedWalk?.id ? null : walk);
            
            if (walk && map) {
                // First zoom to marker location
                map.flyTo({
                    center: [walk.longitude, walk.latitude],
                    zoom: 14,
                    duration: 1500,
                    essential: true
                });

                // Highlight the marker
                markersRef.current.forEach(marker => {
                    const markerEl = marker.getElement();
                    if (marker._lngLat.lng === walk.longitude && marker._lngLat.lat === walk.latitude) {
                        markerEl.style.transform += ' scale(1.25)';
                        marker.togglePopup(); // Show popup
                    } else {
                        markerEl.style.transform = markerEl.style.transform.replace(' scale(1.25)', '');
                        marker.getPopup().remove(); // Hide other popups
                    }
                });
            }
        };

        return React.createElement('div', { 
            className: "flex h-full",
            style: { height: '100vh' }
        }, [
            React.createElement(motion.div, { 
                key: 'sidebar',
                className: "w-1/4 bg-gray-50 flex flex-col divide-y divide-gray-200",
                initial: { x: -50, opacity: 0 },
                animate: { x: 0, opacity: 1 },
                transition: { type: "spring", stiffness: 300, damping: 30 }
            }, [
                // Search header
                React.createElement('div', {
                    className: "p-4 bg-white shadow-sm"
                }, [
                    React.createElement('div', {
                        className: "relative"
                    }, [
                        React.createElement('iconify-icon', {
                            className: "absolute left-3 top-1/2 -translate-y-1/2 text-gray-400",
                            icon: "mdi:magnify",
                            width: "20"
                        }),
                        React.createElement('input', {
                            type: "search",
                            placeholder: "Search walks...",
                            className: "w-full pl-10 pr-4 py-2 rounded-lg border border-gray-200 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none"
                        })
                    ])
                ]),
                
                // Walks list with improved scrolling
                React.createElement('div', {
                    className: "flex-1 overflow-y-auto p-4 space-y-4"
                }, 
                    loading ? 
                        // ... existing loading skeleton ...
                        React.createElement('div', { className: "space-y-4" }, /* ... */)
                    : 
                        React.createElement(ListContainer, null,
                            walks.map(walk => 
                                React.createElement(WalkItem, { 
                                    key: walk.id, 
                                    walk: walk,
                                    isSelected: selectedWalk?.id === walk.id,
                                    onSelect: handleWalkSelect
                                })
                            )
                        )
                )
            ]),
            React.createElement('div', { 
                key: 'map-container', 
                className: "flex-1 relative"
            }, [
                React.createElement(MapComponent, { 
                    walks: walks,
                    selectedWalk: selectedWalk,
                    onWalkSelect: (walk, map) => {
                        if (map && !mapInstance) setMapInstance(map);
                        if (walk) handleWalkSelect(walk);
                    }
                }),
                selectedWalk && React.createElement(motion.div, {
                    className: "absolute bottom-4 left-4 right-4 bg-white p-4 rounded-lg shadow-lg",
                    initial: { y: 50, opacity: 0 },
                    animate: { y: 0, opacity: 1 },
                    exit: { y: 50, opacity: 0 }
                }, [
                    // Selected walk details panel
                    React.createElement('h2', {
                        className: "text-xl font-bold mb-2"
                    }, selectedWalk.walk_name),
                    // Add more details as needed
                ])
            ])
        ]);
    };

    // Initialize React app
    document.addEventListener('DOMContentLoaded', () => {
        const container = document.getElementById('walks-app');
        if (container) {
            const root = createRoot(container);
            root.render(React.createElement(WalksApp));
        }
    });
</script>
{% endblock %}