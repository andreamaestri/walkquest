{% extends "base.html" %}
{% load static %}

{% block title %}Walks - WalkQuest{% endblock title %}

{% block extra_css %}
<style>
    /* Map styles - must come first */
    #map {
        width: 100%;
        height: 100vh;
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
    }

    /* Ensure map elements are visible */
    #map > *:not(.mapboxgl-map):not(.mapboxgl-control-container) {
        z-index: 1;
    }

    /* Layout structure */
    .layout-container {
        height: calc(100vh - 4rem);  /* Account for navbar */
        width: 100vw;
        display: flex;
        position: relative;
    }

    /* Sidebar styles */
    .sidebar {
        width: 24rem;
        z-index: 10;
        background: white;
        height: 100%;
        display: flex;
        flex-direction: column;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
    }

    /* Existing styles */
    .walk-card {
        background: white;
        transition: all 0.2s;
    }

    .walk-card:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .walk-card--selected {
        border-left: 4px solid #4F46E5;
    }

    .filter-option {
        transition: all 0.2s;
    }

    .filter-option:hover {
        background-color: #F3F4F6;
    }

    .count {
        color: #6B7280;
        font-size: 0.875rem;
        margin-left: auto;
    }

    .loading::after {
        content: '';
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
{% endblock extra_css %}

{% block content %}
    <!-- Embed JSON data without extra <script> tags -->
    {% if config %}
        {{ config|json_script:"config-data" }}
    {% endif %}
    
    {% if initial_walks %}
        {{ initial_walks|json_script:"walks-data" }}
    {% endif %}

    <!-- Error container -->
    <div id="error-container" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert"></div>

    <!-- Main content -->
    <div class="layout-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <!-- Search Section -->
            <div class="p-4 border-b">
                <div class="relative">
                    <input type="text" 
                           id="search-input"
                           hx-post="{% url 'walks:search' %}"
                           hx-trigger="input changed delay:500ms, search"
                           hx-target="#walk-list"
                           hx-indicator="#search-indicator"
                           class="w-full px-4 py-2 pl-10 border rounded-lg focus:ring-2 focus:ring-primary-500"
                           placeholder="Search walks..."
                           aria-label="Search walks"
                           autocomplete="off">
                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </span>
                    <div id="search-indicator" class="htmx-indicator">
                        <div class="animate-spin h-4 w-4 border-2 border-primary-500"></div>
                    </div>
                </div>
            </div>

            <!-- Filter Sections -->
            <div class="p-4 border-b overflow-y-auto">
                <!-- Difficulty Filters -->
                <div class="difficulty-filters mb-6"
                     hx-post="{% url 'walks:filter' %}"
                     hx-trigger="change from:input[name='difficulty']"
                     hx-target="#walk-list"
                     hx-indicator="#filter-indicator">
                    <div class="filter-group">
                        <h3 class="font-semibold mb-2 text-gray-700">Difficulty Levels</h3>
                        {% if config.filters.difficulties %}
                            {% for difficulty in config.filters.difficulties %}
                                <label class="filter-option block py-1 hover:bg-gray-50 rounded px-2 cursor-pointer" 
                                       data-difficulty="{{ difficulty }}">
                                    <input type="checkbox" 
                                           name="difficulty" 
                                           value="{{ difficulty }}" 
                                           class="mr-2 rounded text-primary-600 focus:ring-primary-500">
                                    <span class="text-gray-700">{{ difficulty }}</span>
                                    <span class="count" data-difficulty-count="{{ difficulty }}">(0)</span>
                                </label>
                            {% endfor %}
                        {% else %}
                            <p class="text-sm text-gray-500">No difficulty levels available</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Feature Filters -->
                <div class="feature-filters"
                     hx-post="{% url 'walks:filter' %}"
                     hx-trigger="change from:input[name='feature']"
                     hx-target="#walk-list"
                     hx-indicator="#filter-indicator">
                    <div class="filter-group">
                        <h3 class="font-semibold mb-2 text-gray-700">Features</h3>
                        {% if config.filters.features %}
                            {% for feature in config.filters.features %}
                                <label class="filter-option block py-1 hover:bg-gray-50 rounded px-2 cursor-pointer" 
                                       data-feature="{{ feature }}">
                                    <input type="checkbox" 
                                           name="feature" 
                                           value="{{ feature }}" 
                                           class="mr-2 rounded text-primary-600 focus:ring-primary-500">
                                    <span class="text-gray-700">{{ feature|title }}</span>
                                    <span class="count" data-feature-count="{{ feature }}">(0)</span>
                                </label>
                            {% endfor %}
                        {% else %}
                            <p class="text-sm text-gray-500">No features available</p>
                        {% endif %}
                    </div>
                </div>
                <div id="filter-indicator" class="htmx-indicator flex justify-center items-center py-2">
                    <div class="animate-spin h-4 w-4 border-2 border-primary-500"></div>
                </div>
            </div>

            <!-- Walk List -->
            <div id="walk-list" 
                 class="flex-1 overflow-auto" 
                 role="list"
                 hx-get="{% url 'walks:list' %}"
                 hx-trigger="load delay:100ms"
                 hx-swap="innerHTML">
            </div>
        </aside>

        <!-- Map Container - moved outside sidebar -->
        <div class="flex-1 relative">
            <div id="map"></div>
        </div>
    </div>

    <!-- No Results Message -->
    <div id="no-results" class="hidden p-4 text-center text-gray-500">
        No walks found matching your criteria
    </div>

    <!-- Add walk card template -->
    <template id="walk-card-template">
        <div class="walk-card p-4 border-b cursor-pointer" data-walk-id="">
            <h3 class="font-semibold text-gray-900"></h3>
            <div class="mt-1 text-sm text-gray-600">
                <span class="difficulty"></span> | <span class="distance"></span>
            </div>
            <div class="mt-2 flex flex-wrap gap-1 features">
                <!-- Features will be inserted here -->
            </div>
        </div>
    </template>
{% endblock content %}

{% block extra_js %}
    <script>
        // Initialize WALKQUEST global state first
        const initializeWalkQuest = () => {
            const configEl = document.getElementById('config-data');
            const walksEl = document.getElementById('walks-data');
            
            if (!configEl || !walksEl) {
                throw new Error('Required configuration data missing');
            }

            window.WALKQUEST = {
                config: JSON.parse(configEl.textContent),
                initialWalks: JSON.parse(walksEl.textContent)
            };
        };

        // Wait for all resources to load
        window.addEventListener('load', async () => {
            try {
                // Initialize global state first
                initializeWalkQuest();

                // Then load and initialize walkStore
                const { walkStore } = await import("{% static 'js/project.js' %}");
                await walkStore.initialize('map', 'walk-list');

            } catch (error) {
                console.error('Failed to initialize:', error);
                const errorContainer = document.getElementById('error-container');
                if (errorContainer) {
                    errorContainer.textContent = 'Error: ' + error.message;
                    errorContainer.classList.remove('hidden');
                }
            }
        });

        // Remove HTMX event handlers for map loading spinner
        document.addEventListener('htmx:afterRequest', (evt) => {
            if (evt.detail.successful) {
                walkStore.updateMapFromResults(evt.detail.xhr.response);
            }
        });
    </script>
{% endblock %}