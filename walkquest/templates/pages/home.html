{% extends "base.html" %}
{% load i18n %}

{% block title %}{% translate "Walks" %} - {{ block.super }}{% endblock %}

{% block content %}
<div id="walks-app" style="height: 100vh; width: 100%;">
    <!-- React will render here -->
</div>
{% endblock %}

{% block extra_javascript %}
<script type="module">
    import React, { useState, useEffect, useRef } from 'react';
    import { createRoot } from 'react-dom/client';
    import maplibregl from 'https://esm.run/maplibre-gl';
    import { motion, AnimatePresence } from 'framer-motion';

    const MapComponent = ({ walks }) => {
        const mapContainer = useRef(null);
        const [map, setMap] = useState(null);
        const markersRef = useRef([]);

        const clearMarkers = () => {
            markersRef.current.forEach(marker => marker.remove());
            markersRef.current = [];
        };

        // Add markers for walks
        useEffect(() => {
            if (!map || !walks) return;

            clearMarkers();

            walks.forEach(walk => {
                if (!walk.latitude || !walk.longitude) return;

                // Create marker HTML element
                const markerEl = document.createElement('div');
                markerEl.className = 'marker';
                
                // Create popup with walk details
                const popupContent = `
                    <div class="p-2">
                        <h3 class="font-bold mb-1">${walk.walk_name}</h3>
                        <p class="text-sm text-gray-600">${(walk.distance / 1000).toFixed(1)}km</p>
                        <div class="flex gap-2 mt-1">
                            ${walk.has_pub ? '<span class="text-xs px-2 py-1 bg-amber-100 rounded">Pub</span>' : ''}
                            ${walk.has_cafe ? '<span class="text-xs px-2 py-1 bg-blue-100 rounded">Caf√©</span>' : ''}
                        </div>
                        ${walk.features.length > 0 ? `
                            <div class="text-xs text-gray-500 mt-1">
                                ${walk.features.map(f => f.name).join(' ‚Ä¢ ')}
                            </div>
                        ` : ''}
                    </div>
                `;

                const popup = new maplibregl.Popup({ 
                    offset: 25,
                    closeButton: false,
                    maxWidth: '300px'
                }).setHTML(popupContent);

                // Create marker with custom options
                const marker = new maplibregl.Marker({
                    color: walk.has_pub ? '#f59e0b' : '#3b82f6', // Amber for pubs, blue for others
                    scale: 0.8,
                    draggable: false
                })
                    .setLngLat([walk.longitude, walk.latitude])
                    .setPopup(popup)
                    .addTo(map);

                // Show popup on hover
                markerEl.addEventListener('mouseenter', () => marker.togglePopup());
                
                markersRef.current.push(marker);
            });

            // Fit bounds if we have markers
            if (markersRef.current.length > 0) {
                const bounds = new maplibregl.LngLatBounds();
                walks.forEach(walk => {
                    if (walk.latitude && walk.longitude) {
                        bounds.extend([walk.longitude, walk.latitude]);
                    }
                });
                map.fitBounds(bounds, { 
                    padding: 50,
                    maxZoom: 15 
                });
            }
        }, [map, walks]);

        // Initial map setup
        useEffect(() => {
            console.log('MapComponent mounted, container:', mapContainer.current);
            
            if (!mapContainer.current) return;

            try {
                console.log('Initializing map...');
                const mapInstance = new maplibregl.Map({
                    container: mapContainer.current,
                    style: 'https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json',
                    center: [-4.85, 50.4],
                    zoom: 9.5
                });

                mapInstance.on('load', () => {
                    console.log('Map loaded successfully');
                });

                setMap(mapInstance);

                return () => {
                    console.log('Cleaning up map');
                    mapInstance.remove();
                };
            } catch (error) {
                console.error('Error initializing map:', error);
            }
        }, []);

        return React.createElement('div', {
            ref: mapContainer,
            className: "w-full h-full bg-gray-200",
            style: { minHeight: '500px' }
        });
    };

    const WalkItem = React.memo(({ walk, onSelect, isSelected }) => {
        return React.createElement(motion.div, {
            className: `walk-item p-4 rounded-lg mb-3 ${isSelected ? 'bg-blue-50 border-blue-200' : 'bg-white'}`,
            initial: { opacity: 0, y: 20 },
            animate: { opacity: 1, y: 0 },
            exit: { opacity: 0, x: -100 },
            whileHover: { scale: 1.02 },
            whileTap: { scale: 0.98 },
            transition: { type: "spring", stiffness: 500, damping: 30 },
            onClick: () => onSelect(walk),
            layout: true
        }, [
            React.createElement('div', { 
                key: 'header',
                className: "flex items-center justify-between mb-2"
            }, [
                React.createElement('h3', { 
                    className: "font-semibold text-lg"
                }, walk.walk_name),
                React.createElement('span', {
                    className: "text-sm font-medium px-3 py-1 bg-gray-100 rounded-full"
                }, `${(walk.distance / 1000).toFixed(1)}km`)
            ]),
            React.createElement('div', {
                key: 'features',
                className: "flex flex-wrap gap-2"
            }, [
                walk.has_pub && React.createElement(motion.span, {
                    className: "text-xs px-2 py-1 bg-amber-100 rounded-full",
                    whileHover: { scale: 1.1 }
                }, "üç∫ Pub"),
                walk.has_cafe && React.createElement(motion.span, {
                    className: "text-xs px-2 py-1 bg-blue-100 rounded-full",
                    whileHover: { scale: 1.1 }
                }, "‚òï Caf√©"),
                ...walk.features.map(feature => 
                    React.createElement(motion.span, {
                        key: feature.slug,
                        className: "text-xs px-2 py-1 bg-green-100 rounded-full",
                        whileHover: { scale: 1.1 }
                    }, feature.name)
                )
            ])
        ]);
    });

    const WalksApp = () => {
        const [walks, setWalks] = useState([]);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [selectedWalk, setSelectedWalk] = useState(null);

        useEffect(() => {
            const fetchWalks = async () => {
                try {
                    const response = await fetch('/api/walks', {
                        headers: {
                            'Accept': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('Fetched data:', data); // Debug log
                    setWalks(Array.isArray(data) ? data : []);
                    setError(null);
                } catch (error) {
                    console.error('Error fetching walks:', error);
                    setError('Failed to load walks');
                    setWalks([]);
                } finally {
                    setLoading(false);
                }
            };

            fetchWalks();
        }, []);

        const handleWalkSelect = (walk) => {
            setSelectedWalk(walk);
            // Fly to the selected walk's location
            if (map && walk.latitude && walk.longitude) {
                map.flyTo({
                    center: [walk.longitude, walk.latitude],
                    zoom: 14,
                    duration: 2000,
                    essential: true
                });
            }
        };

        if (loading) {
            return React.createElement(motion.div, {
                className: "flex items-center justify-center h-full",
                initial: { opacity: 0 },
                animate: { opacity: 1 }
            }, 
                React.createElement('div', { 
                    className: "loading-spinner"
                }, "Loading walks...")
            );
        }

        if (error) {
            return React.createElement('div', { className: "p-4 text-red-600" }, error);
        }

        return React.createElement('div', { 
            className: "flex h-full",
            style: { height: '100vh' }
        }, [
            React.createElement(motion.div, { 
                key: 'sidebar',
                className: "w-1/4 bg-gray-50 p-4 overflow-y-auto shadow-lg",
                initial: { x: -50, opacity: 0 },
                animate: { x: 0, opacity: 1 },
                transition: { type: "spring", stiffness: 300, damping: 30 }
            }, 
                React.createElement(AnimatePresence, null,
                    walks.map(walk => 
                        React.createElement(WalkItem, { 
                            key: walk.id, 
                            walk: walk,
                            isSelected: selectedWalk?.id === walk.id,
                            onSelect: handleWalkSelect
                        })
                    )
                )
            ),
            React.createElement('div', { 
                key: 'map-container', 
                className: "flex-1 relative"
            }, [
                React.createElement(MapComponent, { walks: walks }),
                selectedWalk && React.createElement(motion.div, {
                    className: "absolute bottom-4 left-4 right-4 bg-white p-4 rounded-lg shadow-lg",
                    initial: { y: 50, opacity: 0 },
                    animate: { y: 0, opacity: 1 },
                    exit: { y: 50, opacity: 0 }
                }, [
                    // Selected walk details panel
                    React.createElement('h2', {
                        className: "text-xl font-bold mb-2"
                    }, selectedWalk.walk_name),
                    // Add more details as needed
                ])
            ])
        ]);
    };

    // Initialize React app
    document.addEventListener('DOMContentLoaded', () => {
        const container = document.getElementById('walks-app');
        if (container) {
            const root = createRoot(container);
            root.render(React.createElement(WalksApp));
        }
    });
</script>
{% endblock %}