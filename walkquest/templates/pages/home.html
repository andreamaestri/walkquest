{% extends "base.html" %}
{% load static %}

{% block title %}Walks - WalkQuest{% endblock title %}

{% block extra_css %}
<style type="text/tailwindcss">
    /* Only essential styles that can't be inlined */
</style>
{% endblock extra_css %}

{% block content %}
    <!-- JSON data embedding with safeguards -->
    <script type="application/json" id="config-data">
        {% if config %}{{ config|json_script:"config-data"|safe }}{% else %}{}{% endif %}
    </script>
    <script type="application/json" id="walks-data">
        {% if initial_walks %}{{ initial_walks|json_script:"walks-data"|safe }}{% else %}[]{% endif %}
    </script>
    <script type="application/json" id="tags-data">
        {% if tags_data %}{{ tags_data|json_script:"tags-data"|safe }}{% else %}[]{% endif %}
    </script>

    <!-- Error container -->
    <div id="error-container" 
         class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4" 
         role="alert"
         aria-live="polite"></div>

    <!-- Main content with Alpine.js -->
    <div class="h-screen w-screen flex relative overflow-hidden" 
         x-data="walkInterface"
         x-init="await initializeData()"
         x-show="Alpine.store('app').initialized"
         x-cloak>
        
        <!-- Loading State -->
        <div x-show="isLoading" 
             class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50"
             x-transition
             role="status"
             aria-live="polite">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500"
                 aria-label="Loading"></div>
        </div>
        
        <!-- Sidebar -->
        <aside class="w-96 h-full flex-shrink-0 z-10 bg-white flex flex-col shadow-md"
               x-show="showSidebar"
               x-transition
               role="complementary"
               aria-label="Walk filters and list">
            
            <!-- Toggle sidebar button -->
            <button @click="toggleSidebar()"
                    class="absolute -right-12 top-4 bg-white p-2 rounded-r shadow-md"
                    :aria-label="showSidebar ? 'Hide sidebar' : 'Show sidebar'"
                    :aria-expanded="showSidebar">
                <iconify-icon :icon="showSidebar ? 'mdi:chevron-left' : 'mdi:chevron-right'"
                             class="text-xl"
                             aria-hidden="true"></iconify-icon>
            </button>

            <!-- Search section -->
            <div class="p-4 border-b">
                <label for="walk-search" class="sr-only">Search walks</label>
                <div class="relative">
                    <input type="text" 
                           id="walk-search"
                           x-model="searchQuery"
                           @input.debounce.300ms="handleSearch()"
                           class="w-full px-4 py-2 pl-10 border rounded-lg focus:ring-2 focus:ring-primary-500"
                           placeholder="Search walks..."
                           aria-label="Search walks">
                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2" aria-hidden="true">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </span>
                </div>
            </div>

            <!-- Filter Sections with persisted selections -->
            <div class="p-4 border-b overflow-y-auto">
                <div x-data="categoryCombobox({
                    options: JSON.parse(document.getElementById('tags-data').textContent).map(tag => ({
                        value: tag.name,
                        label: tag.name,
                        count: tag.usage_count
                    }))
                })" class="w-full flex flex-col gap-1" @categories-updated="handleFilterChange($event.detail)">
                    <label class="w-fit pl-0.5 text-sm text-gray-700 flex items-center justify-between">
                        Walk Categories
                        <button type="button" 
                                @click="clearSelection()"
                                x-show="selectedOptions.length"
                                class="text-sm text-primary-500 hover:text-primary-600 ml-2">
                            Clear all
                        </button>
                    </label>
                    
                    <!-- Combobox Container -->
                    <div class="relative"
                         x-on:keydown.escape.prevent.stop="isOpen = false"
                         x-on:focusin.window="!$el.contains($event.target) && (isOpen = false)">
                        <!-- Trigger Button -->
                        <button type="button" 
                                class="inline-flex w-full items-center justify-between gap-2 rounded-md border border-gray-300 bg-white px-4 py-2 text-sm shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500 transition"
                                @click="isOpen = !isOpen"
                                @keydown.arrow-down.prevent="isOpen = true; $nextTick(() => $refs.searchInput.focus())"
                                aria-haspopup="listbox"
                                :aria-expanded="isOpen"
                                aria-label="Select walk categories">
                            <span x-text="selectedOptions.length ? `${selectedOptions.length} selected` : 'Select categories'"></span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transition-transform duration-200" :class="{'rotate-180': isOpen}" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                            </svg>
                        </button>

                        <!-- Dropdown -->
                        <div x-show="isOpen" 
                             x-transition:enter="transition ease-out duration-200"
                             x-transition:enter-start="opacity-0 translate-y-1"
                             x-transition:enter-end="opacity-100 translate-y-0"
                             x-transition:leave="transition ease-in duration-150"
                             x-transition:leave-start="opacity-100 translate-y-0"
                             x-transition:leave-end="opacity-0 translate-y-1"
                             @click.outside="isOpen = false"
                             class="absolute z-10 mt-1 w-full rounded-md bg-white shadow-lg max-h-80 overflow-auto focus:outline-none"
                             role="listbox"
                             aria-labelledby="categories-label">
                            
                            <!-- Search Input -->
                            <div class="p-2 border-b">
                                <input type="text"
                                       x-model="searchQuery"
                                       x-ref="searchInput"
                                       placeholder="Search categories..."
                                       class="w-full rounded-md border-gray-300 px-3 py-2 text-sm focus:ring-primary-500 focus:border-primary-500"
                                       @keydown.escape.prevent.stop="isOpen = false"
                                       @keydown.arrow-down.prevent="$nextTick(() => $refs.firstOption?.focus())"
                                       @keydown.arrow-up.prevent="$nextTick(() => $refs.lastOption?.focus())"
                                       aria-label="Search categories"/>
                            </div>

                            <!-- Options List -->
                            <ul class="py-1" role="none">
                                <template x-for="(option, index) in filteredOptions" :key="option.value">
                                    <li class="relative flex items-center px-4 py-2 cursor-pointer hover:bg-gray-100 focus:bg-gray-100 outline-none"
                                        :class="{'bg-gray-100': isSelected(option)}"
                                        @click="toggleOption(option)"
                                        @keydown.enter.prevent="toggleOption(option)"
                                        @keydown.space.prevent="toggleOption(option)"
                                        @keydown.arrow-up.prevent="$el.previousElementSibling?.focus()"
                                        @keydown.arrow-down.prevent="$el.nextElementSibling?.focus()"
                                        :x-ref="index === 0 ? 'firstOption' : (index === filteredOptions.length - 1 ? 'lastOption' : null)"
                                        tabindex="0"
                                        role="option"
                                        :aria-selected="isSelected(option)">
                                        <input type="checkbox"
                                               class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                                               :checked="isSelected(option)"
                                               @click.stop="toggleOption(option)"
                                               aria-label="Select {{ option.label }}">
                                        <span class="ml-3 flex items-center space-x-2">
                                            <span x-text="option.label" class="font-medium"></span>
                                            <span class="ml-auto text-sm text-gray-500" x-text="`(${option.count})`"></span>
                                        </span>
                                    </li>
                                </template>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Walk List -->
            <div id="walk-list" 
                 class="flex-1 overflow-y-auto p-4"
                 x-ref="walkList"
                 role="list"
                 aria-label="Available walks">
                <template x-for="walk in filteredWalks" :key="walk.id">
                    <div class="bg-white transition-all duration-200 cursor-pointer p-4 border-b"
                         @click="selectWalk(walk.id)"
                         @keydown.enter="selectWalk(walk.id)"
                         :class="{ 'bg-primary-50 border-l-4 border-primary-500': selectedWalk === walk.id }"
                         :data-walk-id="walk.id"
                         tabindex="0"
                         role="listitem">
                        <h3 class="font-semibold text-gray-900" x-text="walk.walk_name"></h3>
                        <div class="mt-1 text-sm text-gray-600 flex items-center gap-2">
                            <span class="distance" x-text="formatDistance(walk.distance)"></span>
                            <span x-show="walk.steepness_level" x-text="walk.steepness_level"></span>
                        </div>
                        <div class="mt-2 flex flex-wrap gap-1">
                            <template x-for="category in walk.categories" :key="category">
                                <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-700"
                                      x-text="category">
                                </span>
                            </template>
                        </div>
                        <div class="mt-2 flex gap-2 text-sm text-gray-600">
                            <span x-show="walk.has_pub" class="flex items-center gap-1">
                                <span>🍺</span> Pub
                            </span>
                            <span x-show="walk.has_cafe" class="flex items-center gap-1">
                                <span>☕</span> Café
                            </span>
                        </div>
                    </div>
                </template>

                <!-- States -->
                <div x-show="isLoading" 
                     class="p-4 text-center"
                     role="status"
                     aria-live="polite">
                    <span class="inline-flex items-center">
                        <svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy 12 r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Loading walks...
                    </span>
                </div>

                <div x-show="!isLoading && filteredWalks.length === 0" 
                     class="p-4 text-center text-gray-500"
                     role="status"
                     aria-live="polite">
                    No walks found matching your criteria
                </div>
            </div>
        </aside>

        <!-- Map container -->
        <div class="flex-1 relative h-full" 
             :class="{ 'w-full': !showSidebar }"
             x-transition>
            <div id="map" 
                 x-ref="map"
                 class="w-full h-full"
                 role="region"
                 aria-label="Interactive map of walks"></div>
        </div>
    </div>

    <!-- No Results Message -->
    <div id="no-results" class="hidden p-4 text-center text-gray-500">
        No walks found matching your criteria
    </div>

    <!-- Add walk card template -->
    <template id="walk-card-template">
        <div class="bg-white transition-all duration-200 cursor-pointer p-4 border-b" data-walk-id="">
            <h3 class="font-semibold text-gray-900"></h3>
            <div class="mt-1 text-sm text-gray-600">
                <span class="distance"></span>
            </div>
            <div class="mt-2 flex flex-wrap gap-1 tags">
                <!-- Tags will be inserted here -->
            </div>
        </div>
    </template>

    <!-- Add initialization script -->
    <script>
        function getJsonData(elementId, fallback) {
            try {
                const element = document.getElementById(elementId);
                return element ? JSON.parse(element.textContent) : fallback;
            } catch (e) {
                console.error(`Error parsing ${elementId}:`, e);
                return fallback;
            }
        }

        // Update Alpine.js data initialization
        document.addEventListener('alpine:init', () => {
            Alpine.data('walkInterface', () => ({
                async initializeData() {
                    const config = getJsonData('config-data', {});
                    const walks = getJsonData('walks-data', []);
                    const tags = getJsonData('tags-data', []);
                    
                    await Alpine.store('app').initialize({ config, walks, tags });
                }
                // ... rest of walkInterface implementation
            }));
        });
    </script>
{% endblock content %}

{% block extra_js %}
<script src="{% static 'js/alpine-components.js' %}" type="module"></script>
{% endblock extra_js %}