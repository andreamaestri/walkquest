{% extends "base.html" %}
{% load static %}

{% block content %}
<div id="app" class="h-screen w-screen relative">
    <div id="map" class="fixed inset-0 w-full h-full"></div>
    <div id="sidebar" class="absolute top-4 right-4 bg-white p-4 rounded-lg shadow-lg max-w-md max-h-[calc(100vh-2rem)] overflow-y-auto">
        <h2 class="text-xl font-bold mb-4">Available Walks</h2>
        <div id="walks-list">
            {% for walk in walks %}
            <div class="walk-item mb-4 p-4 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer"
                 data-lat="{{ walk.latitude }}"
                 data-lng="{{ walk.longitude }}"
                 data-title="{{ walk.title }}"
                 data-description="{{ walk.description }}">
                <h3 class="font-bold">{{ walk.title }}</h3>
                <p class="text-sm text-gray-600">{{ walk.description }}</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
window.addEventListener('solid-loaded', () => {
    const { createSignal, onMount } = window.solidJs;
    
    const [map, setMap] = createSignal(null);
    const walkElements = document.querySelectorAll('.walk-item');
    
    onMount(() => {
        // Calculate bounds first
        const bounds = new mapboxgl.LngLatBounds();
        let validCoordinates = false;

        walkElements.forEach(el => {
            const lat = parseFloat(el.dataset.lat);
            const lng = parseFloat(el.dataset.lng);
            
            // Validate coordinates
            if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                bounds.extend([lng, lat]);
                validCoordinates = true;
                console.log(`Valid coordinates added: [${lng}, ${lat}]`);
            } else {
                console.warn(`Invalid coordinates skipped: [${lng}, ${lat}]`);
            }
        });

        if (!validCoordinates) {
            console.error('No valid coordinates found for bounds');
            return;
        }

        console.log('Bounds:', bounds.toString());

        // Initialize map with bounds
        const mapInstance = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/andreamaestri/cm48d1bek014q01sielm24odq',
            bounds: bounds,
            fitBoundsOptions: {
                padding: 50,
                maxZoom: 14
            },
            accessToken: "{{ mapbox_token }}"
        });

        mapInstance.addControl(new mapboxgl.NavigationControl());
        setMap(mapInstance);

        // Add markers
        walkElements.forEach(el => {
            const lat = parseFloat(el.dataset.lat);
            const lng = parseFloat(el.dataset.lng);
            const title = el.dataset.title;
            const description = el.dataset.description;

            if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                new mapboxgl.Marker()
                    .setLngLat([lng, lat])
                    .setPopup(
                        new mapboxgl.Popup({ offset: 25 })
                            .setHTML(`<h3>${title}</h3><p>${description}</p>`)
                    )
                    .addTo(mapInstance);
            }

            // Add click handler
            el.addEventListener('click', () => {
                mapInstance.flyTo({
                    center: [lng, lat],
                    zoom: 14
                });
            });
        });

        // Verify map is centered correctly
        mapInstance.on('load', () => {
            console.log('Map center:', mapInstance.getCenter());
            console.log('Map bounds:', mapInstance.getBounds().toString());
        });
    });
});
</script>
{% endblock %}