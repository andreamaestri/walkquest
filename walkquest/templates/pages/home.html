{% extends "base.html" %}
{% load static %}

{% block title %}Walks - {{ block.super }}{% endblock %}

{% block content %}
<div id="root" class="h-screen w-screen relative">
    <div id="loading" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
        <span class="ml-3">Loading...</span>
    </div>
</div>
{% endblock %}

{% block inline_javascript %}
<script type="module">
    import { createSignal, createEffect, onCleanup, onMount, createMemo } from "https://cdn.skypack.dev/solid-js@1.9.3";
    import { render } from "https://cdn.skypack.dev/solid-js@1.9.3/web";
    import html from "https://cdn.skypack.dev/solid-js@1.9.3/html";
    import mapboxgl from "https://cdn.skypack.dev/mapbox-gl";

    // Initialize data from Django context
    const walkData = {{ walks_json|safe }};
    const markerIcons = {{ marker_icons_json|safe }};
    const featureIcons = {{ feature_icons_json|safe }};
    const availableFeatures = {{ available_features_json|safe }};
    const mapboxToken = '{{ mapbox_token|escapejs }}';

    // Debug the incoming data
    console.log('Initial data loaded:', { walkData, featureIcons, mapboxToken });

    // Configure Mapbox
    mapboxgl.accessToken = mapboxToken;

    // Store Creation
    function createWalkStore() {
        const [walks, setWalks] = createSignal(Array.isArray(walkData) ? walkData : []);
        const [selectedWalk, setSelectedWalk] = createSignal(null);
        const [searchTerm, setSearchTerm] = createSignal('');
        const [sidebarOpen, setSidebarOpen] = createSignal(true);
        
        // Memoize filtered walks to prevent recursive rendering
        const filteredWalks = createMemo(() => {
            const search = searchTerm().toLowerCase();
            return walks().filter(walk => 
                walk?.walk_name?.toLowerCase().includes(search) || 
                walk?.description?.toLowerCase().includes(search)
            );
        });

        return {
            walks,
            selectedWalk,
            searchTerm,
            sidebarOpen,
            filteredWalks,
            toggleSidebar: () => setSidebarOpen(prev => !prev),
            setSearchTerm,
            selectWalk: (walkId) => {
                const walk = walks().find(w => w.id === walkId);
                setSelectedWalk(walk);
            }
        };
    }

    // Components
    const WalkItem = (props) => {
        const isSelected = createMemo(() => props.store.selectedWalk()?.id === props.walk.id);
        
        return html`
            <div class="p-4 border-b hover:bg-gray-50 cursor-pointer ${isSelected() ? 'bg-blue-50' : ''}"
                 onclick=${() => props.store.selectWalk(props.walk.id)}>
                <h3 class="text-lg font-semibold">${props.walk.walk_name}</h3>
                ${props.walk.distance && html`<p class="text-sm text-gray-600">${props.walk.distance} miles</p>`}
            </div>
        `;
    };

    const SearchInput = (props) => html`
        <input type="text"
               class="w-full px-3 py-2 border rounded-lg"
               placeholder="Search walks..."
               value=${props.value}
               oninput=${(e) => props.onSearch(e.target.value)} />
    `;

    const SidebarComponent = (props) => {
        const isOpen = createMemo(() => props.store.sidebarOpen());
        const walks = createMemo(() => props.store.filteredWalks());

        return html`
            <aside class="absolute top-12 ${() => isOpen() ? 'left-4' : '-left-96'} 
                         w-[400px] h-[calc(100vh-4rem)] bg-white shadow-lg rounded-lg mt-4
                         transition-all duration-300 flex flex-col z-10">
                <div class="p-4 border-b">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Available Walks</h2>
                        <button onclick=${() => props.store.toggleSidebar()}
                                class="p-2 hover:bg-gray-100 rounded-full">
                            <iconify-icon icon="mdi:chevron-left"></iconify-icon>
                        </button>
                    </div>
                    ${SearchInput({
                        value: props.store.searchTerm(),
                        onSearch: props.store.setSearchTerm
                    })}
                </div>
                <div class="flex-1 overflow-y-auto">
                    ${() => walks().map(walk => WalkItem({ walk, store: props.store }))}
                </div>
            </aside>
        `;
    };

    const MapComponent = (props) => {
        let mapContainer;
        const [error, setError] = createSignal(null);

        onMount(() => {
            if (!mapContainer || !mapboxToken) {
                setError('Map initialization failed');
                return;
            }

            const map = new mapboxgl.Map({
                container: mapContainer,
                style: 'mapbox://styles/mapbox/outdoors-v12',
                center: [-4.85, 50.40],
                zoom: 9
            });

            map.on('load', () => {
                // Add map sources and layers here
                const walks = props.store.walks();
                if (walks.length) {
                    map.addSource('walks', {
                        type: 'geojson',
                        data: {
                            type: 'FeatureCollection',
                            features: walks.map(walk => ({
                                type: 'Feature',
                                geometry: {
                                    type: 'Point',
                                    coordinates: [walk.longitude, walk.latitude]
                                },
                                properties: { id: walk.id }
                            }))
                        }
                    });

                    map.addLayer({
                        id: 'walks',
                        type: 'circle',
                        source: 'walks',
                        paint: {
                            'circle-radius': 8,
                            'circle-color': '#4F46E5'
                        }
                    });
                }
            });

            onCleanup(() => map?.remove());
        });

        return html`
            <div class="relative w-full h-full">
                <div ref=${el => mapContainer = el} 
                     class="absolute inset-0">
                </div>
                ${error() && html`
                    <div class="absolute top-4 right-4 bg-red-100 text-red-700 p-4 rounded">
                        ${error()}
                    </div>
                `}
            </div>
        `;
    };

    const App = (props) => html`
        <div class="h-screen w-screen relative overflow-hidden">
            ${MapComponent({ store: props.store })}
            ${SidebarComponent({ store: props.store })}
        </div>
    `;

    // Initialize app with error handling
    function initApp() {
        try {
            if (!mapboxToken) throw new Error('Mapbox token is not configured');
            if (!Array.isArray(walkData)) throw new Error('Invalid walk data');

            const store = createWalkStore();
            const root = document.getElementById('root');
            if (!root) throw new Error('Root element not found');

            render(() => App({ store }), root);
            document.getElementById('loading')?.classList.add('hidden');
        } catch (error) {
            console.error('App initialization failed:', error);
            const loading = document.getElementById('loading');
            if (loading) {
                loading.innerHTML = `
                    <div class="text-red-500">
                        <p class="font-bold">Error:</p>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
    }

    // Start the app
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initApp);
    } else {
        initApp();
    }
</script>
{% endblock %}