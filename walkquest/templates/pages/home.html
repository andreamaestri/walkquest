{% extends "base.html" %}
{% load static %}

{% block title %}Walks - {{ block.super }}{% endblock %}

{% block css %}
{{ block.super }}
<style>
  .mapboxgl-popup-content { @apply p-4 rounded-lg shadow-lg; }
  .walk-card { @apply p-4 border-b hover:bg-gray-50 transition-colors; }
  .walk-card--selected { @apply bg-blue-50; }
</style>
{% endblock %}

{% block head %}
{{ block.super }}
<script id="app-config" type="application/json">
  {
    "walks": {{ walks_json|safe }},
    "mapboxToken": "{{ mapbox_token|escapejs }}",
    "featureIcons": {{ feature_icons_json|safe }},
    "config": {
      "map": {
        "style": "mapbox://styles/mapbox/outdoors-v12",
        "defaultCenter": [-4.85, 50.40],
        "defaultZoom": 9,
        "markerColors": {
          "default": "#4F46E5",
          "selected": "#DC2626"
        }
      },
      "ui": {
        "list": {
          "itemSize": 92,
          "overscan": 5,
          "debounceMs": 300
        }
      }
    }
  }
</script>
{% endblock %}

{% block content %}
<div id="root" class="h-screen w-screen relative">
  <div id="loading" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
    <span class="ml-3">Loading...</span>
  </div>
</div>
{% endblock %}

{% block inline_javascript %}
<script type="module">
  import { createSignal, createEffect, createMemo, onCleanup, onMount } from "https://cdn.skypack.dev/solid-js";
  import { render } from "https://cdn.skypack.dev/solid-js/web";
  import html from "https://cdn.skypack.dev/solid-js/html";
  import { createVirtualizer } from "https://cdn.skypack.dev/@tanstack/solid-virtual";
  import mapboxgl from "https://cdn.skypack.dev/mapbox-gl";

  // Configuration initialization with validation
  const getAppConfig = () => {
    return new Promise((resolve, reject) => {
      try {
        const configEl = document.getElementById('app-config');
        if (!configEl) {
          throw new Error('Configuration element not found');
        }
        const config = JSON.parse(configEl.textContent);
        
        // Validate required fields
        const required = ['walks', 'mapboxToken', 'featureIcons', 'config'];
        const missing = required.filter(key => !config[key]);
        
        if (missing.length > 0) {
          throw new Error(`Missing required configuration: ${missing.join(', ')}`);
        }

        resolve(config);
      } catch (error) {
        reject(error);
      }
    });
  };

  // Store Creation
  const createStore = (initialData) => {
    const [walks, setWalks] = createSignal(initialData.walks || []);
    const [selectedWalk, setSelectedWalk] = createSignal(null);
    const [searchTerm, setSearchTerm] = createSignal("");
    const [sidebarOpen, setSidebarOpen] = createSignal(true);
    const [error, setError] = createSignal(null);

    const filteredWalks = createMemo(() => {
      const term = searchTerm().toLowerCase().trim();
      return !term 
        ? walks()
        : walks().filter(w => 
            w.walk_name.toLowerCase().includes(term) || 
            w.description?.toLowerCase().includes(term)
          );
    });

    return {
      walks,
      selectedWalk,
      searchTerm,
      sidebarOpen,
      error,
      filteredWalks,
      actions: {
        selectWalk: (id) => {
          const walk = walks().find(w => w.id === id);
          setSelectedWalk(walk);
        },
        setSearch: (term) => setSearchTerm(term),
        toggleSidebar: () => setSidebarOpen(prev => !prev),
        setError: (err) => setError(err)
      }
    };
  };

  // Components
  const SearchBar = ({ value, onChange }) => html`
    <div class="p-4 border-b">
      <input
        type="text"
        value=${value}
        onInput=${(e) => onChange(e.target.value)}
        placeholder="Search walks..."
        class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
      />
    </div>
  `;

  const WalkCard = ({ walk, selected, onClick }) => html`
    <div 
      class="walk-card ${selected ? 'walk-card--selected' : ''}"
      onClick=${onClick}
    >
      <h3 class="text-lg font-semibold">${walk.walk_name}</h3>
      ${walk.distance && html`
        <div class="mt-2 text-sm text-gray-600">
          <iconify-icon icon="mdi:map-marker-distance"></iconify-icon>
          ${walk.distance} miles
        </div>
      `}
    </div>
  `;

  const WalkList = ({ walks, selectedId, onSelect }) => {
    let containerRef;
    
    const virtualizer = createVirtualizer({
      count: () => walks().length,
      getScrollElement: () => containerRef,
      estimateSize: () => 92,
      overscan: 5
    });

    return html`
      <div 
        ref=${el => containerRef = el}
        class="flex-1 overflow-auto"
      >
        <div style="height: ${virtualizer.getTotalSize()}px; position: relative;">
          ${() => virtualizer.getVirtualItems().map(virtualRow => {
            const walk = walks()[virtualRow.index];
            return html`
              <div
                style="position: absolute; top: 0; left: 0; width: 100%; 
                       height: ${virtualRow.size}px; 
                       transform: translateY(${virtualRow.start}px);"
              >
                <${WalkCard}
                  walk=${walk}
                  selected=${selectedId() === walk.id}
                  onClick=${() => onSelect(walk.id)}
                />
              </div>
            `;
          })}
        </div>
      </div>
    `;
  };

  const Map = ({ store }) => {
    let mapContainer;
    let map;
    const markers = {};

    const initializeMap = () => {
      map = new mapboxgl.Map({
        container: mapContainer,
        style: APP_CONFIG.config.map.style,
        center: APP_CONFIG.config.map.defaultCenter,
        zoom: APP_CONFIG.config.map.defaultZoom
      });

      map.on('load', () => {
        store.walks().forEach(addMarker);
      });
    };

    const addMarker = (walk) => {
      if (!walk.latitude || !walk.longitude) return;

      const marker = new mapboxgl.Marker({
        color: APP_CONFIG.config.map.markerColors.default
      })
        .setLngLat([walk.longitude, walk.latitude])
        .addTo(map);

      markers[walk.id] = marker;

      marker.getElement().addEventListener('click', () => {
        store.actions.selectWalk(walk.id);
      });
    };

    onMount(() => {
      initializeMap();
    });

    createEffect(() => {
      const selected = store.selectedWalk();
      if (selected && map) {
        map.flyTo({
          center: [selected.longitude, selected.latitude],
          zoom: 14
        });

        Object.entries(markers).forEach(([id, marker]) => {
          marker.setColor(
            id === selected.id
              ? APP_CONFIG.config.map.markerColors.selected
              : APP_CONFIG.config.map.markerColors.default
          );
        });
      }
    });

    onCleanup(() => {
      Object.values(markers).forEach(m => m.remove());
      map?.remove();
    });

    return html`
      <div ref=${el => mapContainer = el} class="w-full h-full"></div>
    `;
  };

  // Error Boundary Component
  const ErrorBoundary = (props) => {
    const [error, setError] = createSignal(null);

    return html`
      ${error() ? html`
        <div class="p-4 bg-red-100 text-red-700 rounded-lg">
          <h3 class="font-bold">Error</h3>
          <p>${error().message}</p>
        </div>
      ` : props.children}
    `;
  };

  // Main App with Error Handling
  const App = ({ config, onError }) => {
    const store = createStore(config);

    onMount(() => {
      if (!config.mapboxToken) {
        onError(new Error('Mapbox token is required'));
        return;
      }
    });

    return html`
      <${ErrorBoundary}>
        <div class="h-screen w-screen flex">
          ${() => store.sidebarOpen() && html`
            <aside class="w-96 flex flex-col bg-white shadow-lg">
              <${SearchBar}
                value=${store.searchTerm()}
                onChange=${store.actions.setSearch}
              />
              <${WalkList}
                walks=${store.filteredWalks}
                selectedId=${() => store.selectedWalk()?.id}
                onSelect=${store.actions.selectWalk}
              />
            </aside>
          `}
          <${Map} store=${store} />
        </div>
      </${ErrorBoundary}>
    `;
  };

  // Initialization
  async function initializeApp() {
    try {
      // Wait for DOM to be ready
      if (document.readyState !== 'complete') {
        await new Promise(resolve => {
          window.addEventListener('load', resolve);
        });
      }

      // Get configuration
      const config = await getAppConfig();
      
      // Initialize Mapbox
      mapboxgl.accessToken = config.mapboxToken;

      // Initialize app
      const root = document.getElementById('root');
      if (!root) throw new Error('Root element not found');

      render(() => html`
        <${App} 
          config=${config}
          onError=${(error) => {
            console.error('App Error:', error);
            root.innerHTML = `
              <div class="p-4 bg-red-100 text-red-700 rounded-lg">
                <h3 class="font-bold">Error</h3>
                <p>${error.message}</p>
              </div>
            `;
          }}
        />
      `, root);

      // Remove loading indicator
      const loadingEl = document.getElementById('loading');
      if (loadingEl) loadingEl.remove();

    } catch (error) {
      console.error('Initialization error:', error);
      const root = document.getElementById('root');
      if (root) {
        root.innerHTML = `
          <div class="p-4 bg-red-100 text-red-700 rounded-lg">
            <h3 class="font-bold">Initialization Error</h3>
            <p>${error.message}</p>
          </div>
        `;
      }
      const loadingEl = document.getElementById('loading');
      if (loadingEl) loadingEl.remove();
    }
  }

  // Start initialization
  initializeApp();
</script>
{% endblock %}