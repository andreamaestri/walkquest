{% extends "base.html" %}
{% load static %}

{% block title %}Walks - {{ block.super }}{% endblock %}

{% block css %}
{{ block.super }}
<style>
    .overflow-container { -webkit-overflow-scrolling: touch; }
</style>
{% endblock %}

{% block content %}
<div id="root" class="h-screen w-screen relative">
    <div id="loading" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
        <span class="ml-3">Loading...</span>
    </div>
</div>

<script>
    window.APP_DATA = {
        walks: [
            {% for walk in walks %}
                {
                    id: "{{ walk.id }}",
                    walk_name: "{{ walk.walk_name|escapejs }}",
                    description: "{{ walk.description|escapejs }}",
                    latitude: {{ walk.latitude|default:"null" }},
                    longitude: {{ walk.longitude|default:"null" }},
                    distance: {{ walk.distance|default:"null" }},
                    duration: "{{ walk.duration|default:""|escapejs }}",
                    features: {{ walk.features|safe|default:"[]" }}
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        mapboxToken: "{{ mapbox_token|default:'' }}",
        featureIcons: {{ feature_icons|safe }}
    };

    // Validate required data
    if (!window.APP_DATA.mapboxToken) {
        console.error('Mapbox token is missing');
        document.getElementById('loading').innerHTML = '<div class="text-red-600">Error: Map configuration is incomplete</div>';
    }
    
    // Debug log
    console.log('Initial APP_DATA:', window.APP_DATA);
</script>
{% endblock %}

{% block inline_javascript %}
<script type="module">
    import { 
        createSignal, 
        createEffect, 
        onCleanup, 
        onMount, 
        createMemo,
        batch,
        For,
        ErrorBoundary
    } from "https://cdn.skypack.dev/solid-js";
    import { render } from "https://cdn.skypack.dev/solid-js/web";
    import html from "https://cdn.skypack.dev/solid-js/html";
    import { createVirtualizer } from "https://cdn.skypack.dev/@tanstack/solid-virtual";
    import mapboxgl from "https://cdn.skypack.dev/mapbox-gl";

    // Utility Functions
    const debounce = (fn, ms) => {
        let timeoutId;
        return (...args) => {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => fn(...args), ms);
        };
    };

    const safeExecute = (fn, fallback = null) => {
        try {
            return fn();
        } catch (error) {
            console.error('Operation failed:', error);
            return fallback;
        }
    };

    // Constants
    const UI_STATES = {
        LOADING: 'loading',
        ERROR: 'error',
        EMPTY: 'empty',
        READY: 'ready'
    };

    const LIST_CONFIG = {
        itemSize: 92,
        overscan: 5,
        debounceMs: 300,
        loadingItems: 3
    };

    const MAP_CONFIG = {
        style: 'mapbox://styles/mapbox/outdoors-v12',
        defaultCenter: [-4.85, 50.40],
        defaultZoom: 9,
        markerColors: {
            default: '#4F46E5',
            selected: '#DC2626'
        }
    };

    // Extract configuration from window.APP_DATA
    const { walks: initialWalks, mapboxToken, featureIcons } = window.APP_DATA;

    // Validate configuration before proceeding
    const validateConfig = () => {
        const required = ['mapboxToken', 'walks'];
        const missing = required.filter(key => !window.APP_DATA?.[key]);
        
        if (missing.length > 0) {
            throw new Error(`Missing required configuration: ${missing.join(', ')}`);
        }
        
        if (!Array.isArray(window.APP_DATA.walks)) {
            throw new Error('Invalid walks data format');
        }
        
        return true;
    };

    // Set Mapbox token globally after validation
    if (validateConfig()) {
        mapboxgl.accessToken = window.APP_DATA.mapboxToken;
    }

    // Constants and Configuration
    const UI_STATES = {
        LOADING: 'loading',
        ERROR: 'error',
        EMPTY: 'empty',
        READY: 'ready'
    };

    const LIST_CONFIG = {
        itemSize: 92,
        overscan: 5,
        debounceMs: 300,
        loadingItems: 3
    };

    const MAP_CONFIG = {
        style: 'mapbox://styles/mapbox/outdoors-v12',
        defaultCenter: [-4.85, 50.40],
        defaultZoom: 9,
        markerColors: {
            default: '#4F46E5',
            selected: '#DC2626'
        }
    };

    // Enhanced Store Creation
    function createWalkStore() {
        const [uiState, setUiState] = createSignal(UI_STATES.LOADING);
        const [walks, setWalks] = createSignal([]);
        const [selectedWalk, setSelectedWalk] = createSignal(null);
        const [searchTerm, setSearchTerm] = createSignal('');
        const [sidebarOpen, setSidebarOpen] = createSignal(true);
        const [error, setError] = createSignal(null);
        const [isLoading, setIsLoading] = createSignal(true); // Add loading signal

        const filteredWalks = createMemo(() => {
            const items = walks();
            const search = searchTerm().toLowerCase().trim();
            return !search ? items : items.filter(walk => 
                walk?.walk_name?.toLowerCase().includes(search) || 
                walk?.description?.toLowerCase().includes(search)
            );
        });

        // Initialize store with validation
        setTimeout(() => {
            try {
                const walks = window.APP_DATA.walks;
                if (!Array.isArray(walks)) {
                    throw new Error('Invalid walks data format');
                }
                setWalks(walks);
                setUiState(walks.length ? UI_STATES.READY : UI_STATES.EMPTY);
                setIsLoading(false);
            } catch (err) {
                setError(err.message);
                setUiState(UI_STATES.ERROR);
                setIsLoading(false);
            }
        }, 0);

        return {
            uiState,
            walks,
            selectedWalk,
            searchTerm,
            sidebarOpen,
            error,
            filteredWalks,
            isLoading, // Expose isLoading signal
            setSearchTerm: (term) => {
                batch(() => {
                    setSearchTerm(term);
                    if (selectedWalk()) setSelectedWalk(null);
                });
            },
            selectWalk: (walkId) => {
                const walk = walks().find(w => w.id === walkId);
                setSelectedWalk(walk);
            },
            toggleSidebar: () => setSidebarOpen(prev => !prev),
            reset: () => {
                batch(() => {
                    setSearchTerm('');
                    setSelectedWalk(null);
                    setError(null);
                    setUiState(UI_STATES.LOADING);
                    setIsLoading(true);
                    setWalks(initialWalks);
                    setUiState(initialWalks.length ? UI_STATES.READY : UI_STATES.EMPTY);
                    setIsLoading(false);
                });
            }
        };
    }

    // Components
    const WalkItem = ({ walk, store, selected }) => html`
        <div class="p-4 border-b hover:bg-gray-50 cursor-pointer ${selected ? 'bg-blue-50' : ''}"
             onclick=${() => store.selectWalk(walk.id)}>
            <h3 class="text-lg font-semibold">${walk.walk_name}</h3>
            ${walk.distance && html`
                <div class="flex items-center mt-2 text-sm text-gray-600">
                    <iconify-icon icon="mdi:map-marker-distance" class="mr-1"></iconify-icon>
                    ${walk.distance} miles
                </div>
            `}
        </div>
    `;

    const LoadingOverlay = () => html`
        <div class="absolute inset-0 bg-white bg-opacity-75 
                    flex items-center justify-center z-50
                    transition-opacity duration-300">
            <div class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-12 w-12 
                            border-b-2 border-primary"></div>
                <span class="mt-2">Loading walks...</span>
            </div>
        </div>
    `;

    const WalkCardSkeleton = () => html`
        <div class="p-4 border-b animate-pulse">
            <div class="h-6 bg-gray-200 rounded w-3/4"></div>
            <div class="mt-2 h-4 bg-gray-200 rounded w-1/2"></div>
        </div>
    `;

    // Enhanced SearchInput with debounced search
    const SearchInput = ({ value, onSearch }) => {
        const debouncedSearch = debounce((value) => {
            onSearch(value);
        }, 300);

        return html`
            <input type="text"
                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                   placeholder="Search walks..."
                   value=${value}
                   oninput=${e => debouncedSearch(e.target.value)} />
        `;
    };

    // Fixed VirtualWalkList
    const VirtualWalkList = (props) => {
        let parentRef;
        
        const virtualizer = createVirtualizer({
            count: () => props.walks().length,
            getScrollElement: () => parentRef,
            estimateSize: () => 92,
            overscan: 5
        });

        return html`
            <div ref=${el => parentRef = el} 
                 class="flex-1 overflow-auto relative">
                ${() => props.isLoading() ? html`
                    <${WalkCardSkeleton} />
                    <${WalkCardSkeleton} />
                    <${WalkCardSkeleton} />
                ` : html`
                    <div style="height: ${virtualizer.getTotalSize()}px; position: relative;">
                        ${() => {
                            const walks = props.walks();
                            return virtualizer.getVirtualItems().map(virtualRow => {
                                const walk = walks[virtualRow.index];
                                if (!walk) return null;
                                
                                return html`
                                    <div style="position: absolute; top: 0; left: 0; width: 100%; 
                                              height: ${virtualRow.size}px; 
                                              transform: translateY(${virtualRow.start}px);">
                                        <${WalkCard} 
                                            walk=${walk}
                                            selected=${() => props.selectedId() === walk.id}
                                            onSelect=${() => props.onSelect(walk.id)}
                                        />
                                    </div>
                                `;
                            });
                        }}
                    </div>
                `}
                ${() => !props.isLoading() && props.walks().length === 0 && html`
                    <div class="p-4 text-center text-gray-500">
                        No walks found
                    </div>
                `}
            </div>
        `;
    };

    const WalkCard = (props) => {
        if (!props.walk) return null;

        const isSelected = createMemo(() => props.selected());
        
        return html`
            <div class="p-4 border-b hover:bg-gray-50 cursor-pointer transition-colors
                        ${() => isSelected() ? 'bg-blue-50' : 'bg-white'}"
                 onclick=${() => props.onSelect(props.walk.id)}
                 role="button"
                 tabindex="0">
                <h3 class="text-lg font-semibold truncate">${props.walk.walk_name}</h3>
                <div class="mt-2 flex items-center gap-4 text-sm text-gray-600">
                    ${props.walk.distance && html`
                        <span class="flex items-center">
                            <iconify-icon icon="mdi:map-marker-distance" class="mr-1" />
                            ${props.walk.distance} miles
                        </span>
                    `}
                    ${props.walk.duration && html`
                        <span class="flex items-center">
                            <iconify-icon icon="mdi:clock-outline" class="mr-1" />
                            ${props.walk.duration}
                        </span>
                    `}
                </div>
                ${props.walk.features?.length > 0 && html`
                    <div class="mt-2 flex flex-wrap gap-1">
                        ${props.walk.features.map(feature => html`
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full 
                                       text-xs bg-blue-100 text-blue-800">
                                <iconify-icon icon="${featureIcons[feature]}" class="mr-1" />
                                ${feature}
                            </span>
                        `)}
                    </div>
                `}
            </div>
        `;
    };

    // Updated Sidebar Component
    const Sidebar = (props) => {
        const store = props.store;
        
        if (!store) {
            console.error('Store is missing in Sidebar');
            return null;
        }

        const walks = createMemo(() => store.filteredWalks());
        const selectedId = createMemo(() => store.selectedWalk()?.id);
        
        return html`
            <aside class="w-96 h-full bg-white shadow-lg flex flex-col">
                <div class="p-4 border-b">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Available Walks</h2>
                        <button onclick=${store.toggleSidebar}
                                class="p-2 hover:bg-gray-100 rounded-full">
                            <iconify-icon icon="mdi:chevron-left" />
                        </button>
                    </div>
                    <${SearchInput}
                        value=${store.searchTerm()}
                        onSearch=${store.setSearchTerm}
                    />
                </div>
                <${VirtualWalkList}
                    walks=${walks}
                    selectedId=${selectedId}
                    onSelect=${store.selectWalk}
                    isLoading=${store.isLoading}
                />
            </aside>
        `;
    };

    // Map component with enhanced marker management and error handling
    const Map = ({ store }) => {
        const [error, setError] = createSignal(null);
        const [isInitialized, setIsInitialized] = createSignal(false);
        let mapContainer;
        let mapInstance;
        
        // Create marker store with signal
        const [markers, setMarkers] = createSignal({});

        // Enhanced marker creation with error handling
        const createMarker = (walk) => {
            try {
                const popup = new mapboxgl.Popup({
                    closeButton: false,
                    closeOnClick: true
                }).setHTML(`
                    <div class="p-2">
                        <h3 class="font-bold text-gray-900">${walk.walk_name}</h3>
                        ${walk.distance ? `
                            <p class="text-sm text-gray-600">
                                <span class="font-medium">${walk.distance}</span> miles
                            </p>
                        ` : ''}
                    </div>
                `);

                const marker = new mapboxgl.Marker({
                    color: store.selectedWalk()?.id === walk.id 
                        ? APP_CONFIG.map.markerColors.selected 
                        : APP_CONFIG.map.markerColors.default
                })
                .setLngLat([walk.longitude, walk.latitude])
                .setPopup(popup);

                marker.getElement().addEventListener('click', () => {
                    store.selectWalk(walk.id);
                });

                return { marker, popup };
            } catch (err) {
                setError(`Failed to create marker: ${err.message}`);
                return null;
            }
        };

        // Batch update markers
        const updateMarkers = () => {
            batch(() => {
                const currentWalks = store.walks();
                const currentMarkers = markers();

                // Remove unused markers
                Object.entries(currentMarkers).forEach(([id, marker]) => {
                    if (!currentWalks.find(w => w.id === id)) {
                        marker.popup?.remove();
                        marker.marker?.remove();
                        const updatedMarkers = { ...currentMarkers };
                        delete updatedMarkers[id];
                        setMarkers(updatedMarkers);
                    }
                });

                // Add/update markers
                currentWalks.forEach(walk => {
                    if (!currentMarkers[walk.id]) {
                        const newMarker = createMarker(walk);
                        if (newMarker) {
                            setMarkers(prev => ({ 
                                ...prev, 
                                [walk.id]: newMarker 
                            }));
                            newMarker.marker.addTo(mapInstance);
                        }
                    }
                });
            });
        };

        // Debounced resize handler
        const handleResize = debounce(() => {
            if (mapInstance) {
                mapInstance.resize();
                const selected = store.selectedWalk();
                if (selected) {
                    mapInstance.flyTo({
                        center: [selected.longitude, selected.latitude],
                        zoom: DEFAULT_ZOOM
                    });
                }
            }
        }, 250);

        // Initialize map
        const initializeMap = () => {
            try {
                if (!window.APP_DATA.mapboxToken) {
                    throw new Error('Mapbox token is missing');
                }

                mapInstance = new mapboxgl.Map({
                    container: mapContainer,
                    style: MAP_CONFIG.style,
                    center: MAP_CONFIG.defaultCenter,
                    zoom: MAP_CONFIG.defaultZoom
                });

                mapInstance.on('load', () => {
                    setIsInitialized(true);
                    updateMarkers();
                });

                mapInstance.on('error', (e) => {
                    setError(`Map error: ${e.error.message}`);
                });

                window.addEventListener('resize', handleResize);

            } catch (err) {
                setError(`Failed to initialize map: ${err.message}`);
            }
        };

        // Setup and cleanup
        onMount(() => {
            if (mapContainer) {
                initializeMap();
            }
        });

        onCleanup(() => {
            try {
                // Cleanup markers
                Object.values(markers()).forEach(marker => {
                    marker.popup?.remove();
                    marker.marker?.remove();
                });

                // Cleanup map
                mapInstance?.remove();
                window.removeEventListener('resize', handleResize);
                
                // Reset state
                setMarkers({});
                setError(null);
                setIsInitialized(false);
            } catch (err) {
                console.error('Cleanup error:', err);
            }
        });

        // Watch selected walk changes
        createEffect(() => {
            const selected = store.selectedWalk();
            if (selected && mapInstance) {
                mapInstance.flyTo({
                    center: [selected.longitude, selected.latitude],
                    zoom: 14
                });
                
                // Update marker colors
                Object.entries(markers()).forEach(([id, marker]) => {
                    marker.marker.setColor(
                        id === selected.id 
                            ? APP_CONFIG.map.markerColors.selected 
                            : APP_CONFIG.map.markerColors.default
                    );
                });
            }
        });

        return html`
            <div class="flex-1 relative">
                <div ref=${el => mapContainer = el}
                     class="absolute inset-0">
                </div>
                ${error() && html`
                    <div class="absolute top-4 right-4 bg-red-100 text-red-700 p-4 rounded-lg shadow-lg">
                        <h3 class="font-bold">Map Error</h3>
                        <p>${error()}</p>
                        <button onclick=${initializeMap} 
                                class="mt-2 px-3 py-1 bg-red-200 rounded hover:bg-red-300">
                            Retry
                        </button>
                    </div>
                `}
            </div>
        `;
    };

    const ErrorBoundaryWrapper = (props) => {
        return html`
            <${ErrorBoundary} 
                fallback=${(err, reset) => html`
                    <div class="p-4 bg-red-100 text-red-700 rounded-lg">
                        <h2 class="font-bold">Error</h2>
                        <p>${err.message}</p>
                        <button onclick=${reset}
                                class="mt-2 px-3 py-1 bg-red-200 rounded">
                            Try Again
                        </button>
                    </div>
                `}>
                ${props.children}
            <//>
        `;
    };

    const App = ({ store }) => html`
        <${ErrorBoundaryWrapper}>
            <div class="h-screen w-screen flex relative">
                ${() => store.isLoading() && html`<${LoadingOverlay} />`}
                <${Sidebar} store=${store} />
                <${Map} store=${store} />
            </div>
        <//>
    `;

    // Initialize app
    function initApp() {
        try {
            console.log('Starting app initialization');
            
            // Validate configuration first
            validateConfig();
            
            console.log('Creating store...');
            const store = createWalkStore();
            
            const root = document.getElementById('root');
            if (!root) {
                throw new Error('Root element not found');
            }

            console.log('Rendering app...');
            render(() => html`<${App} store=${store} />`, root);
            
            console.log('App rendered, hiding loading...');
            document.getElementById('loading')?.classList.add('hidden');
            
        } catch (error) {
            console.error('App initialization failed:', error);
            const loading = document.getElementById('loading');
            if (loading) {
                loading.innerHTML = `
                    <div class="text-red-500">
                        <p class="font-bold">Error:</p>
                        <p>${error.message}</p>
                        <pre class="mt-2 text-sm">${error.stack}</pre>
                    </div>
                `;
            }
        }
    }

    // Start the app with proper loading check
    if (document.readyState === 'loading') {
        console.log('Document still loading, waiting...');
        document.addEventListener('DOMContentLoaded', initApp);
    } else {
        console.log('Document ready, initializing app...');
        initApp();
    }
</script>
{% endblock %}