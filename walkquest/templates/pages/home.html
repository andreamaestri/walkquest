{% extends "base.html" %}
{% load static %}

{% block title %}Walks - {{ block.super }}{% endblock %}

{% block extra_head %}
<style>
    .mapboxgl-popup-content { @apply p-4 rounded-lg shadow-lg; }
    .walk-card { @apply p-4 border-b hover:bg-gray-50 transition-colors cursor-pointer; }
    .walk-card--selected { @apply bg-blue-50; }
</style>

<!-- Core Dependencies -->
<script type="module">
    // Use import mapped modules
    import { 
        Virtualizer,
        observeElementOffset,
        observeElementRect,
        elementScroll
    } from '@tanstack/virtual-core';
    import mapboxgl from 'mapbox-gl';

    // Make available globally
    window.mapboxgl = mapboxgl;

    // App Configuration
    window.APP_CONFIG = {
        mapboxToken: "{{ mapbox_token|escapejs }}",
        // featureIcons: {{ feature_icons_json|safe }}
        map: {
            style: "mapbox://styles/mapbox/outdoors-v12",
            defaultCenter: [-4.85, 50.40],
            defaultZoom: 9,
            markerColors: {
                default: "#4F46E5",
                selected: "#DC2626"
            }
        },
        ui: {
            list: {
                itemSize: 92,
                overscan: 5,
                debounceMs: 300
            }
        }
    };

    // Create virtualizer with proper options
    window.createVirtualizer = (container, items) => {
        if (!container) return null;

        return new Virtualizer({
            count: items.length,
            getScrollElement: () => container,
            estimateSize: () => window.APP_CONFIG.ui.list.itemSize,
            overscan: window.APP_CONFIG.ui.list.overscan,
            scrollToFn: elementScroll,
            observeElementRect,
            observeElementOffset,
            onChange: (instance) => {
                instance.measureElement(container);
            }
        });
    };
</script>
<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
{% endblock %}

{% block content %}
<div class="flex h-[calc(100vh-4rem)]">
    <!-- Sidebar with walk list -->
    <div class="w-1/3 overflow-hidden flex flex-col bg-white border-r">
        <div class="p-4 border-b">
            <input type="text" 
                   id="search-input"
                   placeholder="Search walks..." 
                   class="w-full px-4 py-2 border rounded-lg">
        </div>
        <div id="walk-list" class="flex-1 overflow-y-auto"></div>
    </div>
    
    <!-- Map container -->
    <div id="map" class="w-2/3"></div>
</div>
{% endblock %}

{% block inline_javascript %}
<script type="module">
    // Import our modules
    import { walkStore, Icon } from '{% static "js/project.js" %}';
    
    // Initialize with Django template data
    window.MAPBOX_TOKEN = '{{ mapbox_token }}';
    window.INITIAL_WALKS = {{ initial_walks|safe }};
    
    // Wait for DOM and required scripts
    document.addEventListener('DOMContentLoaded', () => {
        if (!window.mapboxgl) {
            console.error('Mapbox GL JS not loaded');
            return;
        }
        
        // Set Mapbox token
        mapboxgl.accessToken = window.MAPBOX_TOKEN;
        
        // Initialize walks
        walkStore.setWalks(window.INITIAL_WALKS);
        
        // Initialize map and list
        walkStore.initialize('map', 'walk-list');
    });
</script>
{% endblock %}